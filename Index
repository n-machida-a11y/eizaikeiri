<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
  
  <title>経費精算システム</title>
  <style>
    /* 読み込み中オーバーレイ */
    #loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.6);
      z-index: 9998;
      display: none; /* 初期状態は非表示 */
      justify-content: center;
      align-items: center;
    }
    #loading-spinner {
      z-index: 9999;
      color: white;
      text-align: center;
    }

    /* ビューの切り替え */
    .app-view {
      display: none; /* すべてのビューを非表示 */
    }
    .app-view.active {
      display: block; /* activeクラスを持つビューのみ表示 */
    }

    /* (v20: タイムシート関連スタイル 削除) */

    /* 承認待ち一覧 (B) */
    .report-list-item {
      cursor: pointer;
    }
    .report-list-item:hover {
      background-color: #f8f9fa;
    }

    /* 申請一覧 (E) */
    #E-my-reports-list-body tr {
      cursor: pointer;
    }
    
    /* (v18) カスタムモーダルはローディングより手前に表示 */
    .modal-backdrop {
      z-index: 10000;
    }
    .modal {
      z-index: 10001;
    }
    
    /* (v21: 要件3-2) 上限超過時のスタイル */
    .amount-over-limit {
      background-color: #fff3cd; /* Bootstrap 'warning' light background */
      border-color: #ffc107;
    }

    /* (v25: 申請一覧のグループヘッダー) */
    .status-group-header td { /* (v26: セレクタをtdに修正) */
      background-color: #e9ecef; /* (v26: gray-200 に変更) */
      border-top: 2px solid #dee2e6; /* (v26: 上ボーダー追加 'gray-300') */
      border-bottom: 1px solid #dee2e6; /* (v26: 下ボーダー追加) */
    }
  </style>
</head>
<body>

  <nav class="navbar navbar-expand-lg navbar-dark bg-dark sticky-top">
    <div class="container-fluid">
      <a class="navbar-brand" href="#"><i class="bi bi-wallet2"></i> 経費精算システム</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav me-auto mb-2 mb-lg-0" id="nav-links">
     
          <li class="nav-item">
            <a class="nav-link" href="#" data-view="view-A-expense-report">
              <i class="bi bi-pencil-square"></i> 経費申請
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#" data-view="view-E-my-reports">
              <i class="bi bi-list-task"></i> 申請一覧
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#" data-view="view-D-expense-summary">
              <i class="bi bi-cash-coin"></i> 経費精算 (最終)
            </a>
          </li>
          <? if (isManager) { ?>
          <li class="nav-item">
            <a class="nav-link" href="#" data-view="view-B-approval-list">
              <i class="bi bi-check2-circle"></i> 承認待ち
              <span class="badge bg-danger" id="approval-count-badge"></span>
            </a>
          </li>
          <? } ?>
        </ul>
        <div class="navbar-text text-white">
          <span id="user-info-display"></span> <i class="bi bi-person-circle"></i>
        </div>
      </div>
    </div>
  </nav>

  <div class="container-fluid p-3 p-md-4">

    <div id="view-A-expense-report" class="app-view">
      <h3 class="mb-3"><i class="bi bi-pencil-square"></i> 経費申請・編集</h3>

      <div id="A-rejection-reason" class="alert alert-danger" style="display: none;"></div>

      <div class="card shadow-sm mb-4">
        <div class="card-body">
          <form id="report-header-form">
            <input type="hidden" id="A-reportId">
            
            <div class="row g-3">
              <div class="col-md-3">
                <label for="A-date" class="form-label">申請日 <span class="text-danger">*</span></label>
                <input type="date" class="form-control" id="A-date" required>
              </div>
              <div class="col-md-5">
                 <label for="A-title" class="form-label">件名 <span class="text-danger">*</span></label>
                <input type="text" class="form-control" id="A-title" placeholder="例: 〇〇出張旅費精算" required>
              </div>
              <div class="col-md-4">
                <label for="A-remarks" class="form-label">備考（全体）</label>
                <input type="text" class="form-control" id="A-remarks" placeholder="特記事項など">
              </div>
            </div>
          </form>
        </div>
      </div>

      <div class="card shadow-sm">
        <div class="card-header d-flex justify-content-between align-items-center">
          <span>経費明細</span>
          <button type="button" class="btn btn-sm btn-primary" onclick="openExpenseModalA(null)">
            <i class="bi bi-plus-lg"></i> 経費明細を追加
          </button>
        </div>
        <div class="table-responsive">
          <table class="table table-hover timesheet-table mb-0">
            <thead class="table-light">
              <tr>
                <th>利用日</th>
                <th>経費項目</th>
                <th>エリア</th> <th>金額 (円)</th>
                <th>備考</th>
                <th style="width: 120px;">領収書</th>
                <th style="width: 80px;">操作</th>
              </tr>
            </thead>
            <tbody id="A-expense-list-body">
              <tr><td colspan="7" class="text-center p-4">「経費明細を追加」ボタンから項目を登録してください。</td></tr>
            </tbody>
            <tfoot class="table-group-divider">
              <tr>
                <td colspan="3" class="text-end fw-bold">合計金額</td>
                <td class="fw-bold text-danger fs-5" id="A-total-expense-amount">0 円</td>
                <td colspan="3"></td>
              </tr>
            </tfoot>
          </table>
        </div>
        <div class="card-footer text-center">
          <button type="button" class="btn btn-secondary" onclick="saveOrSubmitExpenseReportA('一時保存')">
            <i class="bi bi-save"></i> 一時保存
          </button>
          <button type="button" class="btn btn-primary" onclick="saveOrSubmitExpenseReportA('申請中')">
            <i class="bi bi-send-check"></i> 申請する
          </button>
          <button type="button" class="btn btn-outline-danger ms-3" onclick="resetFormA()">
             <i class="bi bi-arrow-clockwise"></i> 入力リセット
          </button>
        </div>
      </div>
      
    </div>

    <div id="view-B-approval-list" class="app-view">
      <h3 class="mb-3"><i class="bi bi-check2-circle"></i> 承認待ち一覧</h3>
      <div class="card shadow-sm">
        <div class="list-group list-group-flush" id="B-approval-list-body">
          </div>
      </div>
    </div>

    <div id="view-C-report-detail" class="app-view">
      <h3 class="mb-3"><i class="bi bi-file-earmark-text"></i> 経費申請 詳細</h3>
      
      <button class="btn btn-outline-secondary mb-3" id="C-back-button">
        <i class="bi bi-arrow-left"></i> 戻る
      </button>

      <div class="card shadow-sm mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
           <h5 class="mb-0" id="C-header-date"></h5>
          <span class="badge fs-6" id="C-header-status-badge"></span>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-6">
              <strong>申請者:</strong> <span id="C-header-applicant"></span>
            </div>
            <div class="col-md-6">
               <strong>申請日:</strong> <span id="C-header-apply-date"></span>
            </div>
            <div class="col-md-6">
              <strong>件名:</strong> <span id="C-header-title"></span>
            </div>
            <div class="col-md-6">
              <strong>合計経費:</strong> <span id="C-header-total-expense" class="text-danger fw-bold"></span> 円
            </div>
            
            <div class="col-12 mt-2">
              <strong>備考:</strong> <pre id="C-header-remarks" class="bg-light p-2 rounded mb-0"></pre>
            </div>
            
            <div class="col-12 mt-2" id="C-rejection-reason-wrapper" style="display: none;">
              <strong>差戻し理由:</strong>
              <pre id="C-rejection-reason" class="bg-danger-subtle text-danger-emphasis p-2 rounded mb-0"></pre>
            </div>
          </div>
        </div>
      </div>

       <div class="card shadow-sm mb-4">
        <div class="card-header">経費明細</div>
        <div class="table-responsive">
          <table class="table table-striped mb-0">
            <thead class="table-light">
              <tr>
                 <th>利用日</th>
                <th>経費項目</th>
                <th>エリア</th> <th>金額 (円)</th>
                <th>備考</th>
                <th>領収書</th>
              </tr>
            </thead>
            <tbody id="C-expenses-body">
              </tbody>
          </table>
        </div>
      </div>

      <div id="C-approval-buttons" class="text-center" style="display: none;">
        <input type="hidden" id="C-reportId">
        <button class="btn btn-danger btn-lg" onclick="handleRejectC()">
          <i class="bi bi-x-circle"></i> 差戻し
        </button>
        <button class="btn btn-success btn-lg ms-3" onclick="handleApproveC()">
          <i class="bi bi-check-circle"></i> 承認する
        </button>
      </div>
    </div>

    <div id="view-D-expense-summary" class="app-view">
      <h3 class="mb-3"><i class="bi bi-cash-coin"></i> 経費精算まとめ (最終申請)</h3>
      
      <div class="alert alert-info">
        「承認済」ステータスで、まだ経費精算が申請されていない申請が表示されます。<br>
        対象を選択し、「精算申請を送信」ボタンを押してください。経理担当者に通知が送信されます。
      </div>

      <div class="card shadow-sm">
        <div class="card-header">
          <div class="d-flex justify-content-between align-items-center">
             <span>精算対象一覧</span>
            <button class="btn btn-sm btn-primary" onclick="submitFinalExpensesD()">
              <i class="bi bi-send-check"></i> 選択した申請の精算申請を送信
            </button>
          </div>
        </div>
        <div class="table-responsive">
          <table class="table table-hover mb-0">
             <thead class="table-light">
              <tr>
                <th style="width: 50px;">
                  <input class="form-check-input" type="checkbox" id="D-check-all" onchange="toggleAllCheckboxesD(this.checked)">
                </th>
                <th>日付</th>
                <th>件名</th>
                <th>合計経費 (円)</th>
                <th>経費詳細</th>
                <th>ID</th>
              </tr>
            </thead>
            <tbody id="D-expense-list-body">
              </tbody>
            <tfoot class="table-group-divider">
              <tr>
                <td colspan="3" class="text-end fw-bold">選択合計</td>
                <td class="fw-bold text-danger fs-5" id="D-total-selected-amount">0 円</td>
                <td colspan="2"></td>
              </tr>
            </tfoot>
          </table>
        </div>
      </div>
    </div>

    <div id="view-E-my-reports" class="app-view">
      <h3 class="mb-3"><i class="bi bi-list-task"></i> 自分の申請履歴</h3>
      <div class="card shadow-sm">
        <div class="card-header">
          <div class="d-flex justify-content-between align-items-center">
             <span>申請履歴</span>
            <button class="btn btn-sm btn-outline-primary" onclick="loadMyReportsE()">
              <i class="bi bi-arrow-clockwise"></i> 更新
            </button>
          </div>
        </div>
        <div class="table-responsive">
          <table class="table table-hover mb-0">
             <thead class="table-light">
              <tr>
                <th>日付</th>
                <th>ステータス</th>
                <th>件名</th>
                <th>合計経費 (円)</th>
                <th>備考 (全体)</th>
                <th>経費詳細</th>
                <th>領収書</th>
                <th>操作</th>
              </tr>
            </thead>
            <tbody id="E-my-reports-list-body">
              </tbody>
          </table>
        </div>
      </div>
    </div>

  </div>
  
  <div id="loading-overlay">
    <div id="loading-spinner">
      <div class="spinner-border" role="status" style="width: 3rem; height: 3rem;">
        <span class="visually-hidden">Loading...</span>
      </div>
      <h4 class="mt-3" id="loading-text">読み込み中...</h4>
    </div>
  </div>


  <div class="modal fade" id="expenseModal" tabindex="-1" aria-labelledby="expenseModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="expenseModalLabel">経費明細の登録・編集</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
         <div class="modal-body">
          <form id="expense-form">
            <input type="hidden" id="M-expenseId">
            
             <div class="mb-3">
               <label for="M-useDate" class="form-label">利用日 <span class="text-danger">*</span></label>
               <input type="date" class="form-control" id="M-useDate" required>
             </div>
             
             <div class="mb-3">
               <label for="M-itemCode" class="form-label">経費項目 <span class="text-danger">*</span></label>
               <select class="form-select" id="M-itemCode" required>
                 <option value="">選択してください</option>
               </select>
             </div>
    
             <div class="mb-3" id="M-area-wrapper" style="display: none;">
               <label for="M-areaCode" class="form-label">エリア <span class="text-danger">*</span></label>
               <select class="form-select" id="M-areaCode">
                 <option value="">選択してください</option>
                 </select>
             </div>

             <div class="mb-3">
               <label for="M-amount" class="form-label">金額 (円) (税込) <span class="text-danger">*</span></label>
               <input type="number" class="form-control" id="M-amount" required step="any" oninput="calculateTaxA(event)">
               <small id="M-amount-limit-display" class="form-text text-muted"></small>
             </div>

             <div class="mb-3">
               <label for="M-taxRateSelect" class="form-label">消費税率</label>
               <div class="input-group">
                 <select class="form-select" id="M-taxRateSelect" onchange="calculateTaxA(event)">
                   <option value="10">10%</option>
                   <option value="8">8%</option>
                   <option value="5">5%</option>
                   <option value="3">3%</option>
                   <option value="0">消費税なし (0%)</option>
                   <option value="other">その他 (手入力)</option>
                 </select>
                 <input type="number" class="form-control" id="M-taxRateInput" placeholder="率(%)" style="display: none;" step="any" oninput="calculateTaxA(event)">
               </div>
             </div>

             <div class="mb-3">
               <label for="M-preTaxAmount" class="form-label">税抜き金額 (円)</label>
               <input type="number" class="form-control" id="M-preTaxAmount" step="any" oninput="calculateTaxA(event)">
             </div>
             <div class="mb-3">
               <label for="M-remarks" class="form-label">備考（内容・訪問先など）</label>
                <input type="text" class="form-control" id="M-remarks" placeholder="例: 駐車代 (〇〇商事様)">
             </div>
              
             <hr class="my-3">
              
             <div class="mb-3">
                <label class="form-label">領収書</label>
                <div>
                  <label class="btn btn-sm btn-outline-primary" for="M-file-upload">
                    <i class="bi bi-upload"></i> 領収書を添付
                  </label>
                  <input type="file" id="M-file-upload" accept="image/*" style="display: none;" onchange="handleFileUploadA(event)">
                </div>
                
                <div id="M-upload-status" class="mt-2"></div>
             </div>
              
             <div class="mb-3">
                <label for="M-receiptUrl" class="form-label">領収書URL</label>
               <input type="text" class="form-control" id="M-receiptUrl" readonly>
             </div>
              
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-danger me-auto" id="M-delete-expense" onclick="deleteExpenseItemA()" style="display: none;">
            <i class="bi bi-trash"></i> この明細を削除
          </button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">閉じる</button>
          <button type="button" class="btn btn-primary" onclick="addExpenseItemA()">
            <i class="bi bi-check-lg"></i> この内容で登録
          </button>
         </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="customAlertModal" tabindex="-1" aria-labelledby="customAlertModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="customAlertModalLabel">情報</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
           <p id="customAlertMessage"></p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-primary" data-bs-dismiss="modal" id="customAlertOkButton">OK</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="customPromptModal" tabindex="-1" aria-labelledby="customPromptModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
           <h5 class="modal-title" id="customPromptModalLabel">差戻し理由</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <label for="customPromptInput" class="form-label" id="customPromptMessage">差戻し理由を入力してください（必須）:</label>
          <textarea class="form-control" id="customPromptInput" rows="3"></textarea>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
           <button type="button" class="btn btn-primary" id="customPromptOkButton">OK</button>
        </div>
      </div>
    </div>
  </div>


  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    // --- グローバル変数 -------------------------------------------------
    
    // GASから渡されるデータ
    var EMPLOYEE_INFO = <?!= employeeInfo ?>; // (v21: 拡張。positionCode, jobTypeCodeなどを含む)
    var IS_MANAGER = <?!= isManager ?>;
    var EXPENSE_ITEMS_MASTER = <?!= expenseItems ?>;
    
    // (v21: 新規マスタ) (要件3-1)
    var TRAVEL_RULES_MASTER = <?!= travelRules ?>;
    var AREA_MASTER = <?!= areaMaster ?>;
    var POSITION_MASTER = <?!= positionMaster ?>;
    var DEPARTMENT_MASTER = <?!= departmentMaster ?>;
    var JOB_TYPE_MASTER = <?!= jobTypeMaster ?>;

    // (v21: マスタのマップ)
    var AREA_MASTER_MAP = {};
    
    // (A) 経費申請用データ (v24: taxRate, preTaxAmount 追加)
    var currentExpenses = []; // [ { expenseId, useDate, itemCode, amount, remarks, receiptUrl, areaCode, taxRate, preTaxAmount }, ... ]
    
    // (A) 経費モーダルのインスタンス
    var expenseModalInstance;
    // (C) 詳細画面の遷移元
    var viewC_ReturnView = 'view-E-my-reports';
    
    // (v18) カスタムモーダルのインスタンスとコールバック
    var customAlertModalInstance;
    var customPromptModalInstance;
    var customAlertCallback = null;
    var customPromptCallback = null;

    // (v22: 新規) カメラのストリームを保持 (v25: 削除)
    // var currentStream = null;
    
    // (v21: 新規) 経費モーダルの現在の上限額
    var currentExpenseLimit = 0;
    
    // (v24: 新規) 税計算の無限ループ防止フラグ
    var isCalculatingTax = false;


    // --- 初期化 -------------------------------------------------------

    /**
     * DOM読み込み完了時の初期化処理
     */
    document.addEventListener('DOMContentLoaded', function() {
      // ユーザー情報表示
      document.getElementById('user-info-display').textContent = EMPLOYEE_INFO.name || 'ゲスト';
      
      // ナビゲーションの初期化
      buildNavigation();
      
      // (A) 経費モーダルの初期化
      expenseModalInstance = new bootstrap.Modal(document.getElementById('expenseModal'));
      document.getElementById('expenseModal').addEventListener('hidden.bs.modal', onExpenseModalHideA);
      
      // (v21: 経費モーダルのイベントリスナー) (要件3-3)
      document.getElementById('M-itemCode').addEventListener('change', onItemCodeChangeA);
      document.getElementById('M-areaCode').addEventListener('change', onAreaCodeChangeA);
      // document.getElementById('M-amount').addEventListener('input', onAmountInputA); // (v24: calculateTaxA に移動)
      
      // (v18) カスタムモーダルの初期化
      initializeCustomModalsA();

      // (A) 経費モーダルの項目マスタ読み込み
      loadExpenseItemsMasterA();
      loadAreaMasterA(); // (v21: 新規)
      
      // (C) 詳細画面の戻るボタン
      document.getElementById('C-back-button').addEventListener('click', function() {
        showView(viewC_ReturnView);
      });
      
      // デフォルトビューの表示
      showView('view-A-expense-report');
    });

    /**
     * ナビゲーションバーのリンクとイベントリスナーを設定
     */
    function buildNavigation() {
      var navLinks = document.getElementById('nav-links');
      navLinks.querySelectorAll('.nav-link').forEach(function(link) {
        link.addEventListener('click', function(e) {
          e.preventDefault();
          var viewId = e.currentTarget.dataset.view;
          showView(viewId);
          
          var navbar = document.getElementById('navbarNav');
          var bsCollapse = bootstrap.Collapse.getInstance(navbar);
           if (bsCollapse && navbar.classList.contains('show')) {
            bsCollapse.hide();
          }
        });
      });
    }

    /**
     * (A) 経費モーダルの項目マスタを読み込む
     */
    function loadExpenseItemsMasterA() {
      var select = document.getElementById('M-itemCode');
      select.innerHTML = '<option value="">選択してください</option>';
      
      EXPENSE_ITEMS_MASTER.forEach(function(item) {
        var option = document.createElement('option');
        option.value = item['経費項目コード'];
        option.textContent = item['経費項目'];
        select.appendChild(option);
      });
    }
    
    /**
     * (v21: 新規) (A) エリアマスタをモーダルとマップに読み込む (要件3-3)
     */
    function loadAreaMasterA() {
      var select = document.getElementById('M-areaCode');
      select.innerHTML = '<option value="">選択してください</option>';
      AREA_MASTER_MAP = {}; // マップを初期化
      
      AREA_MASTER.forEach(function(item) {
        // ★★★ 修正箇所 (スプレッドシートのヘッダー名 '地域区分' に合わせる) ★★★
        var code = item['地域区分'];
        var name = item['地域区分名'];
        
        var option = document.createElement('option');
        option.value = code;
        option.textContent = name;
        select.appendChild(option);
        
        // マップにも保存 (View A のリスト表示用)
        AREA_MASTER_MAP[code] = name;
      });
    }


    // --- 汎用: ビュー切り替え & UI ------------------------------------

    /**
     * (v18) カスタムAlert/Promptモーダルの初期化
     */
    function initializeCustomModalsA() {
      var alertModalEl = document.getElementById('customAlertModal');
      customAlertModalInstance = new bootstrap.Modal(alertModalEl);
      
      alertModalEl.addEventListener('hidden.bs.modal', function() {
        if (typeof customAlertCallback === 'function') {
          customAlertCallback();
          customAlertCallback = null;
        }
      });
      
      var promptModalEl = document.getElementById('customPromptModal');
      customPromptModalInstance = new bootstrap.Modal(promptModalEl);
      
      document.getElementById('customPromptOkButton').addEventListener('click', function() {
        var value = document.getElementById('customPromptInput').value;
        if (typeof customPromptCallback === 'function') {
          customPromptCallback(value);
          customPromptCallback = null;
        }
        customPromptModalInstance.hide();
      });
      
      promptModalEl.addEventListener('hidden.bs.modal', function() {
        if (typeof customPromptCallback === 'function') {
          customPromptCallback(null);
          customPromptCallback = null;
        }
      });
    }
    
    /**
     * (v18) カスタムAlertを表示
     */
    function showCustomAlert(message, callback) {
      document.getElementById('customAlertMessage').textContent = message;
      document.getElementById('customAlertModalLabel').textContent = '情報';
      
      if (message.indexOf('エラー') > -1 || message.indexOf('失敗') > -1) {
         document.getElementById('customAlertModalLabel').textContent = 'エラー';
      }
      
      customAlertCallback = callback || null;
      customAlertModalInstance.show();
    }
    
    /**
     * (v18) カスタムPromptを表示
     */
    function showCustomPrompt(message, callback) {
      document.getElementById('customPromptMessage').textContent = message;
      document.getElementById('customPromptInput').value = '';
      customPromptCallback = callback;
      customPromptModalInstance.show();
    }
    

    /**
     * 指定されたIDのビューを表示し、他を非表示にする
     */
    function showView(viewId) {
      document.querySelectorAll('.app-view').forEach(function(view) {
        view.classList.remove('active');
      });
      
      document.querySelectorAll('#nav-links .nav-link').forEach(function(link) {
        if (link.dataset.view === viewId) {
          link.classList.add('active');
        } else {
          link.classList.remove('active');
        }
      });
      
      var targetView = document.getElementById(viewId);
      if (targetView) {
        targetView.classList.add('active');
        
        switch (viewId) {
          case 'view-A-expense-report':
            if (!document.getElementById('A-date').value) {
              document.getElementById('A-date').value = getTodayString();
            }
            break;
          case 'view-B-approval-list':
            loadPendingReportsB();
            break;
          case 'view-D-expense-summary':
            loadApprovedExpensesD();
            break;
          case 'view-E-my-reports':
            loadMyReportsE();
            break;
        }
      } else {
        console.error('View not found: ' + viewId);
      }
    }

    /**
     * ローディングオーバーレイの表示/非表示
     */
    function showLoading(show, text) {
      text = text || '読み込み中...';
      var overlay = document.getElementById('loading-overlay');
      document.getElementById('loading-text').textContent = text;
      overlay.style.display = show ? 'flex' : 'none';
    }

    /**
     * 汎用APIエラーハンドラ (v18)
     */
    function onApiError(error) {
      showLoading(false);
      
      var message = '不明なエラーが発生しました。';
      if (typeof error === 'string') {
        message = error;
      } else if (error && error.message) {
        var gasErrorMsg = error.message.split('->').pop();
        message = gasErrorMsg ? gasErrorMsg.trim() : error.message;
      }

      console.error('API Error:', error);
      showCustomAlert('エラーが発生しました:\n' + message);
    }

    /**
     * 今日の日付を "YYYY-MM-DD" 形式で取得
     */
    function getTodayString() {
      var today = new Date();
      today.setHours(today.getHours() + 9);
      return today.toISOString().split('T')[0];
    }
    
    /**
     * 数値をカンマ区切りにフォーマット
     */
    function formatNumber(num) {
      return (num || 0).toLocaleString();
    }
    
    /**
     * (v17) "yyyy-MM-dd" または "yyyy/MM/dd" を "yyyy/MM/dd (曜)" に変換
     */
    function formatDateWithDay(dateStr) {
      if (!dateStr) return '日付不明';
      try {
        var date = new Date(dateStr.replace(/-/g, '/'));
        var yyyy = date.getFullYear();
        var mm = ('0' + (date.getMonth() + 1)).slice(-2);
        var dd = ('0' + date.getDate()).slice(-2);
        var day = ['日', '月', '火', '水', '木', '金', '土'][date.getDay()];
        return yyyy + '/' + mm + '/' + dd + ' (' + day + ')';
      } catch (e) {
        return dateStr;
      }
    }

    /**
     * (v29: 新規) HTMLエスケープ
     */
    function escapeHTML(str) {
      if (typeof str !== 'string' || !str) return '';
      return str.replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;');
    }


    // --- (A) 経費申請機能 (v20: 大幅修正 / v21: 拡張) ---------------------

    /**
     * (A) フォーム(A)全体をリセットする
     */
    function resetFormA() {
      document.getElementById('report-header-form').reset();
      document.getElementById('A-reportId').value = '';
      document.getElementById('A-date').value = getTodayString();
      
      var reasonDiv = document.getElementById('A-rejection-reason');
      reasonDiv.textContent = '';
      reasonDiv.style.display = 'none';
      
      currentExpenses = [];
      
      renderExpenseListA();
    }

    /**
     * (A) (v20 新規 / v21: エリア列追加) 経費明細リストを描画する (要件3-5)
     */
    function renderExpenseListA() {
      var tbody = document.getElementById('A-expense-list-body');
      tbody.innerHTML = '';
      var totalAmount = 0;

      if (currentExpenses.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="text-center p-4">「経費明細を追加」ボタンから項目を登録してください。</td></tr>'; // (v21: colspan=7)
      } else {
        currentExpenses.forEach(function(ex) {
          var tr = document.createElement('tr');
          var item = EXPENSE_ITEMS_MASTER.find(function(m) { return m['経費項目コード'] === ex.itemCode; });
          var itemName = item ? item['経費項目'] : ex.itemCode;
          var urlLink = ex.receiptUrl ? '<a href="' + ex.receiptUrl + '" target="_blank" rel="noopener noreferrer"><i class="bi bi-box-arrow-up-right"></i></a>' : 'なし';
          
          // (v21: エリア名を取得)
          var areaName = ex.areaCode ? (AREA_MASTER_MAP[ex.areaCode] || ex.areaCode) : '';

          tr.innerHTML = 
            '<td>' + (ex.useDate || 'N/A') + '</td>' +
            '<td>' + (itemName || '不明') + '</td>' +
            '<td>' + areaName + '</td>' + // (v21: 新規)
            '<td>' + formatNumber(ex.amount) + '</td>' + // (v24: カンマ区切り)
            '<td>' + (ex.remarks || '') + '</td>' +
            '<td>' + urlLink + '</td>' +
            '<td>' +
              '<button type="button" class="btn btn-sm btn-outline-primary" onclick="openExpenseModalA(\'' + ex.expenseId + '\')">' +
                '<i class="bi bi-pencil"></i>' +
              '</button>' +
            '</td>';
          
          tbody.appendChild(tr);
          totalAmount += parseFloat(ex.amount) || 0;
        });
      }
      
      document.getElementById('A-total-expense-amount').textContent = formatNumber(totalAmount) + ' 円';
    }


    /**
     * (A) 経費モーダルを開く (v20: 修正 / v21: 拡張 / v24: 税率読込) (要件3-4)
     */
    function openExpenseModalA(expenseId) {
      document.getElementById('expense-form').reset();
      document.getElementById('M-expenseId').value = '';
      
      // (v21: 規定関連リセット)
      resetModalTravelRuleUI();
      
      // (v22: カメラ・アップロード状態をリセット) (v25: stopCamera 削除)
      document.getElementById('M-upload-status').innerHTML = '';
      document.getElementById('M-receiptUrl').value = '';
      // stopCameraA(); // (v25: 削除)

      // (v24: 税率入力欄リセット)
      document.getElementById('M-taxRateSelect').value = '10';
      document.getElementById('M-taxRateInput').value = '';
      document.getElementById('M-taxRateInput').style.display = 'none';
      document.getElementById('M-preTaxAmount').value = '';
      
      var deleteButton = document.getElementById('M-delete-expense');
      
      if (expenseId) {
        // (v20) 編集モード
        var expenseToEdit = currentExpenses.find(function(ex) {
          return ex.expenseId === expenseId;
        });
        
        if (expenseToEdit) {
          document.getElementById('M-expenseId').value = expenseToEdit.expenseId;
          document.getElementById('M-useDate').value = expenseToEdit.useDate.replace(/\//g, '-');
          document.getElementById('M-itemCode').value = expenseToEdit.itemCode;
          document.getElementById('M-amount').value = expenseToEdit.amount;
          document.getElementById('M-remarks').value = expenseToEdit.remarks;
          document.getElementById('M-receiptUrl').value = expenseToEdit.receiptUrl;
          document.getElementById('M-areaCode').value = expenseToEdit.areaCode || ''; // (v21: 読込)
          
          // (v24: 税率・税抜き金額の読み込み)
          document.getElementById('M-preTaxAmount').value = expenseToEdit.preTaxAmount;
          var taxRate = expenseToEdit.taxRate;
          var taxSelect = document.getElementById('M-taxRateSelect');
          var taxInput = document.getElementById('M-taxRateInput');
          
          // taxRateが標準の選択肢にあるかチェック
          var standardOptions = ['10', '8', '5', '3', '0'];
          if (taxRate !== undefined && standardOptions.includes(String(taxRate))) {
            taxSelect.value = String(taxRate);
            taxInput.style.display = 'none';
          } else if (taxRate !== undefined) {
            // 標準以外（その他）の場合
            taxSelect.value = 'other';
            taxInput.value = taxRate;
            taxInput.style.display = 'block';
          } else {
            // taxRateが保存されていない古いデータの場合（デフォルト）
            taxSelect.value = '10';
            taxInput.style.display = 'none';
          }

          deleteButton.style.display = 'inline-block';

          // (v21: 読込時にUIを復元) (要件3-4)
          updateModalUIOnLoadA();
          
        } else {
           showCustomAlert('エラー: 編集対象の経費が見つかりませんでした。');
           return;
        }
      } else {
        // (v20) 新規モード
        document.getElementById('M-useDate').value = document.getElementById('A-date').value || getTodayString();
        deleteButton.style.display = 'none';
      }
      
      expenseModalInstance.show();
    }
    
    /**
     * (A) 経費モーダル非表示時の処理 (v22: 修正 / v24: 税率入力欄リセット / v25: stopCamera削除)
     */
    function onExpenseModalHideA() {
      document.getElementById('expense-form').reset();
      document.getElementById('M-upload-status').innerHTML = '';
      document.getElementById('M-delete-expense').style.display = 'none';
      
      // (v21: 規定関連リセット)
      resetModalTravelRuleUI();
      
      // (v24: 税率入力欄リセット)
      document.getElementById('M-taxRateInput').value = '';
      document.getElementById('M-taxRateInput').style.display = 'none';
      document.getElementById('M-taxRateSelect').value = '10';
      
      // stopCameraA(); // (v25: 削除)
    }

    /**
     * (v24: 新規) ファイル選択でアップロード
     */
    function handleFileUploadA(event) {
      var file = event.target.files[0];
      if (!file) {
        return;
      }

      // (v25: stopCamera 削除)
      // stopCameraA(); 
      
      var reader = new FileReader();
      var statusEl = document.getElementById('M-upload-status');
      
      reader.onload = function(e) {
        var base64Image = e.target.result;

        // アップロード処理
        statusEl.innerHTML = '<span class="text-primary"><div class="spinner-border spinner-border-sm" role="status"></div> ファイルをアップロード中です...</span>';
        showLoading(true, '画像をアップロード中...');
        
        google.script.run
          .withSuccessHandler(onUploadSuccessA)
          .withFailureHandler(onApiError)
          .uploadBase64Image(base64Image);
      };
      
      reader.onerror = function(e) {
        statusEl.innerHTML = '<span class="text-danger">ファイルの読み取りに失敗しました。</span>';
        onApiError('ファイルの読み取りに失敗しました。');
      };
      
      reader.readAsDataURL(file);
      
      // inputの値をクリアして同じファイルを連続で選択できるようにする
      event.target.value = null;
    }
     
    /**
     * (v25: 削除) stopCameraA
     */

    /**
     * (v25: 削除) startCameraA
     */
    
    /**
     * (v25: 削除) captureImageA
     */
    
    /**
     * (v22: 新規) 画像アップロード成功時のコールバック
     */
    function onUploadSuccessA(result) {
      showLoading(false);
      var statusEl = document.getElementById('M-upload-status');
      
      if (result.status === 'success' && result.url) {
        statusEl.innerHTML = '<span class="text-success"><i class="bi bi-check-circle-fill"></i> アップロードが完了しました。</span>';
        
        // 領収書URLに設定
        document.getElementById('M-receiptUrl').value = result.url;
        
      } else {
        onApiError((result && result.message) || 'アップロードに失敗しました。');
        statusEl.innerHTML = '<span class="text-danger"><i class="bi bi-exclamation-triangle-fill"></i> アップロードに失敗しました。</span>';
      }
    }

    /**
     * (A) モーダルから経費アイテムを currentExpenses に追加 (v20: 修正 / v21: areaCode追加 / v24: 税率・税抜追加) (要件3-4)
     */
    function addExpenseItemA() {
      var form = document.getElementById('expense-form');
      if (!form.checkValidity()) {
        form.classList.add('was-validated');
        showCustomAlert('必須項目（利用日、経費項目、金額(税込)' + (document.getElementById('M-area-wrapper').style.display === 'block' ? '、エリア' : '') + '）を入力してください。');
        return;
      }
      form.classList.remove('was-validated');
      
      var expenseId = document.getElementById('M-expenseId').value;
      
      // (v24: 税率取得)
      var taxRateSelect = document.getElementById('M-taxRateSelect').value;
      var finalTaxRate;
      if (taxRateSelect === 'other') {
        finalTaxRate = parseFloat(document.getElementById('M-taxRateInput').value) || 0;
      } else {
        finalTaxRate = parseFloat(taxRateSelect);
      }
      
      var expense = {
        useDate: document.getElementById('M-useDate').value,
        itemCode: document.getElementById('M-itemCode').value,
        amount: parseFloat(document.getElementById('M-amount').value) || 0,
        remarks: document.getElementById('M-remarks').value,
        receiptUrl: document.getElementById('M-receiptUrl').value,
        areaCode: document.getElementById('M-areaCode').value, // (v21: 追加)
        taxRate: finalTaxRate, // (v24: 追加)
        preTaxAmount: parseFloat(document.getElementById('M-preTaxAmount').value) || 0 // (v24: 追加)
      };

      if (expenseId) {
        // 編集モード
        expense.expenseId = expenseId;
        var index = currentExpenses.findIndex(function(ex) { return ex.expenseId === expenseId; });
        if (index > -1) {
          currentExpenses[index] = expense;
        } else {
          currentExpenses.push(expense);
        }
      } else {
        // 新規モード
        expense.expenseId = 'temp_' + Date.now();
        currentExpenses.push(expense);
      }
      
      renderExpenseListA();
      
      expenseModalInstance.hide();
    }
    
    /**
     * (A) (v19) 経費アイテムを削除
     */
    function deleteExpenseItemA() {
      var expenseId = document.getElementById('M-expenseId').value;
      
      if (!expenseId) {
        showCustomAlert('削除対象の経費が見つかりません。');
        return;
      }
      
      showCustomAlert('この経費明細を削除します。よろしいですか？', function() {
        currentExpenses = currentExpenses.filter(function(ex) {
          return ex.expenseId !== expenseId;
        });
        
        renderExpenseListA();
        
        expenseModalInstance.hide();
      });
    }

    /**
     * (A) 経費申請の保存または申請 (v20: 修正)
     */
    function saveOrSubmitExpenseReportA(status) {
      
      var reportDate = document.getElementById('A-date').value;
      var reportTitle = document.getElementById('A-title').value;
      if (!reportDate || !reportTitle) {
        showCustomAlert('申請日と件名は必須です。');
        return;
      }
      
      if (currentExpenses.length === 0) {
        showCustomAlert('経費明細が1件も入力されていません。');
        return;
      }
      
      var confirmMessage = '「' + status + '」で送信します。よろしいですか？';
      if (status === '申請中') {
         confirmMessage += '\n※申請後は編集できなくなります。';
      }
      
      showCustomAlert(confirmMessage, function() {
        showLoading(true, status + '処理を実行中...');
        
        var headerData = {
           reportId: document.getElementById('A-reportId').value,
          date: reportDate,
          title: reportTitle,
          remarks: document.getElementById('A-remarks').value,
        };
        
        var reportData = {
          header: headerData,
          expenses: currentExpenses
        };
        
        google.script.run
          .withSuccessHandler(function(result) {
            showLoading(false);
            if (result && result.status === 'success') {
              showCustomAlert(result.message, function() {
                 resetFormA();
                showView('view-E-my-reports');
              });
            } else {
              // (v21: サーバーからの詳細なエラーメッセージを表示)
              onApiError((result && result.message) || '保存処理に失敗しました。');
            }
          })
           .withFailureHandler(onApiError)
          .saveOrSubmitExpenseReport(reportData, status);
      });
    }

    // --- (v24: 新規) 税率計算ロジック ------------------------------------

    /**
     * (v24: 新規) 税率、税込、税抜の自動計算
     */
    function calculateTaxA(event) {
      // 無限ループ防止
      if (isCalculatingTax) return;
      isCalculatingTax = true;
      
      try {
        var elId = event.target.id;
        
        var amountEl = document.getElementById('M-amount');
        var preTaxEl = document.getElementById('M-preTaxAmount');
        var taxSelect = document.getElementById('M-taxRateSelect');
        var taxInput = document.getElementById('M-taxRateInput');

        // 1. 税率の確定
        if (elId === 'M-taxRateSelect' && taxSelect.value === 'other') {
          taxInput.style.display = 'block';
          // 「その他」を選んだだけでは再計算しない
          isCalculatingTax = false;
          return;
        } else if (elId === 'M-taxRateSelect') {
          taxInput.style.display = 'none';
        }
        
        var taxRate;
        if (taxSelect.value === 'other') {
          taxRate = parseFloat(taxInput.value) || 0;
        } else {
          taxRate = parseFloat(taxSelect.value);
        }

        // 2. 金額の取得
        var amount = parseFloat(amountEl.value) || 0;
        var preTaxAmount = parseFloat(preTaxEl.value) || 0;
        
        // 3. 計算の実行
        // 優先順位：税率変更 > 税抜変更 > 税込変更
        if (elId === 'M-taxRateSelect' || elId === 'M-taxRateInput') {
          // 税率が変わった時 -> 税込から税抜を計算
          if (amount > 0) {
            preTaxEl.value = calculatePreTax(amount, taxRate);
          }
        } else if (elId === 'M-preTaxAmount') {
          // 税抜が変わった時 -> 税込を計算
          amountEl.value = calculateAmount(preTaxAmount, taxRate);
        } else if (elId === 'M-amount') {
          // 税込が変わった時 -> 税抜を計算
          preTaxEl.value = calculatePreTax(amount, taxRate);
        }

      } catch (e) {
        console.error('Tax calculation error:', e);
      }
      
      isCalculatingTax = false;
      
      // (v21) 上限チェックを（税計算後にも）実行
      checkAmountLimitA();
    }
    
    /**
     * (v24: 新規) 税抜金額を計算 (小数点以下切り捨て)
     */
    function calculatePreTax(amount, taxRate) {
      if (taxRate < 0) taxRate = 0;
      var rate = 1 + (taxRate / 100);
      if (rate === 0) return amount;
      // 経理計算上、税抜金額は切り捨てが一般的
      // (v26: 浮動小数点誤差を補正するため、微小な値を加えてから切り捨てる)
      return Math.floor((amount / rate) + 1e-9);
    }
    
    /**
     * (v24: 新規) 税込金額を計算 (小数点以下切り捨て)
     */
    function calculateAmount(preTaxAmount, taxRate) {
      if (taxRate < 0) taxRate = 0;
      var rate = 1 + (taxRate / 100);
      // 経理計算上、税込金額も切り捨てが一般的
      return Math.floor(preTaxAmount * rate);
    }


    // --- (v21: 新規) 出張旅費規定ロジック (要件3-3, 3-4) -----------------
    
    /**
     * (v21: 新規) モーダルの出張旅費規定関連のUIをリセット
     */
    function resetModalTravelRuleUI() {
      currentExpenseLimit = 0;
      
      var areaWrapper = document.getElementById('M-area-wrapper');
      areaWrapper.style.display = 'none';
      
      var areaSelect = document.getElementById('M-areaCode');
      areaSelect.required = false;
      areaSelect.value = '';
      
      document.getElementById('M-amount-limit-display').textContent = '';
      
      var amountInput = document.getElementById('M-amount');
      amountInput.classList.remove('amount-over-limit');
      // フォーム自体のリセットは呼び出し元 (open/hide) が行う
    }

    /**
     * (v21: 新規) 経費項目(M-itemCode) 変更時のイベント (Req 3-3)
     */
    function onItemCodeChangeA() {
      var itemCode = document.getElementById('M-itemCode').value;
      var amountInput = document.getElementById('M-amount');
      var limitDisplay = document.getElementById('M-amount-limit-display');
      var areaWrapper = document.getElementById('M-area-wrapper');
      var areaSelect = document.getElementById('M-areaCode');
      
      // UIを一旦リセット
      currentExpenseLimit = 0;
      limitDisplay.textContent = '';
      amountInput.classList.remove('amount-over-limit');
      areaWrapper.style.display = 'none';
      areaSelect.required = false;

      if (itemCode === '101') { // 日当
        var allowance = getAllowanceLimitA();
        currentExpenseLimit = allowance;
        
        amountInput.value = allowance;
        // (v28: 修正) 規定額のテキスト表示を削除
        // limitDisplay.textContent = '規定額: ' + formatNumber(allowance) + ' 円';
        
        // (v24: 日当の場合、税率0%に設定し、税抜も同額)
        document.getElementById('M-taxRateSelect').value = '0';
        document.getElementById('M-preTaxAmount').value = allowance;
        document.getElementById('M-taxRateInput').style.display = 'none';
        
      } else if (itemCode === '102') { // 宿泊費
        areaWrapper.style.display = 'block';
        areaSelect.required = true;

        // エリアが選択されたら自動計算が走る (onAreaCodeChangeA)
        // もしエリアが既に選択済みなら計算を実行 (編集モード対応)
        if (areaSelect.value) {
           onAreaCodeChangeA();
        } else {
           // 既定の宿泊費をヒントとして表示
           var rule = getTravelRuleA();
           var baseLodging = (rule && rule['宿泊費']) ? parseFloat(rule['宿泊費']) : 0;
           currentExpenseLimit = baseLodging; // エリア未選択時の暫定上限
           // (v28: 修正) 規定額のテキスト表示を削除
           // limitDisplay.textContent = '基本宿泊費: ' + formatNumber(baseLodging) + ' 円 (エリアを選択してください)';
        }
        
      } else {
        // その他の項目
        // (v24: 101以外の場合は税率を10%に戻す)
        // document.getElementById('M-taxRateSelect').value = '10';
        // document.getElementById('M-taxRateInput').style.display = 'none';
        // (v24: 項目変更時に税込額をクリアしない場合、税計算をトリガーする)
        calculateTaxA({ target: { id: 'M-itemCode' } }); 
      }
      
      // 最後に、現在額が上限を超えていないかチェック
      checkAmountLimitA();
    }
    
    /**
     * (v21: 新規) エリア(M-areaCode) 変更時のイベント (Req 3-3)
     */
    function onAreaCodeChangeA() {
      var itemCode = document.getElementById('M-itemCode').value;
      
      // 宿泊費(102)が選択されている場合のみ計算
      if (itemCode === '102') {
        updateAccommodationLimitA();
      }
    }
    
    /**
     * (v21: 新規) 金額(M-amount) 入力時のイベント (Req 3-3)
     * (v24: calculateTaxA にロジックを移行)
     */
    // function onAmountInputA() {
    //   checkAmountLimitA();
    // }
    
    /**
     * (v21: 新規) モーダル読込時にUIを復元 (編集時用) (Req 3-4)
     */
    function updateModalUIOnLoadA() {
      // 項目変更イベントを発火させて、UI（エリア表示/非表示、上限額）を復元
      onItemCodeChangeA();
      
      // 復元されたUIの後、現在額で上限チェック
      checkAmountLimitA();
    }

    /**
     * (v21: 新規) 現在の入力内容で金額の上限をチェック (Req 3-3)
     */
    function checkAmountLimitA() {
      var amountInput = document.getElementById('M-amount');
      var currentAmount = parseFloat(amountInput.value) || 0;
      
      // currentExpenseLimitが0（=上限なし）の場合はチェックしない
      if (currentExpenseLimit > 0 && currentAmount > currentExpenseLimit) {
        amountInput.classList.add('amount-over-limit');
      } else {
        amountInput.classList.remove('amount-over-limit');
      }
    }

    /**
     * (v21: 新規) ユーザーの出張旅費規定を取得
     */
    function getTravelRuleA() {
       var userPosCode = EMPLOYEE_INFO.positionCode;
       var userJobCode = EMPLOYEE_INFO.jobTypeCode;
       
       // (v21) 役職コードと職種区分コードの両方に一致するルールを探す
       var rule = TRAVEL_RULES_MASTER.find(function(r) {
         return String(r['役職 (コード)']) === String(userPosCode) && 
                String(r['職種区分 (コード)']) === String(userJobCode);
       });
       
       if (!rule) {
         console.warn('出張旅費規定が見つかりません。 Pos: ' + userPosCode + ', Job: ' + userJobCode);
       }
       return rule;
    }
    
    /**
     * (v21: 新規) 日当(101)の規定額を取得 (Req 3-3)
     */
    function getAllowanceLimitA() {
       var rule = getTravelRuleA();
       if (rule && rule['日当']) {
         return parseFloat(rule['日当']);
       }
       return 0; // 規定が見つからない場合
    }
    
    /**
     * (v21: 新規) 宿泊費(102)の規定額を計算し、フォームにセット (Req 3-3)
     */
    function updateAccommodationLimitA() {
      var areaCode = document.getElementById('M-areaCode').value;
      var amountInput = document.getElementById('M-amount');
      var limitDisplay = document.getElementById('M-amount-limit-display');
      
      // 1. 基本宿泊費
      var rule = getTravelRuleA();
      var baseLodging = (rule && rule['宿泊費']) ? parseFloat(rule['宿泊費']) : 0;
      
      if (!areaCode) {
        currentExpenseLimit = baseLodging; // エリア未選択時の上限
        // (v28: 修正) 規定額のテキスト表示を削除
        // limitDisplay.textContent = '基本宿泊費: ' + formatNumber(baseLodging) + ' 円 (エリアを選択してください)';
        checkAmountLimitA();
        return;
      }
      
      // 2. エリア追加宿泊費
      // ★★★ 修正箇所 (スプレッドシートのヘッダー名 '地域区分' に合わせる) ★★★
      var areaRule = AREA_MASTER.find(function(a) {
        return String(a['地域区分']) === String(areaCode);
      });
      var additionalLodging = (areaRule && areaRule['追加宿泊費']) ? parseFloat(areaRule['追加宿泊費']) : 0;
      
      // 3. 合計
      var totalLimit = baseLodging + additionalLodging;
      currentExpenseLimit = totalLimit;
      
      amountInput.value = totalLimit;
      // (v28: 修正) 規定額のテキスト表示を削除
      // limitDisplay.textContent = '上限額: ' + formatNumber(totalLimit) + ' 円 (基本: ' + formatNumber(baseLodging) + ' + エリア追加: ' + formatNumber(additionalLodging) + ')';
      
      // (v24: 宿泊費がセットされたら、税計算も実行)
      calculateTaxA({ target: { id: 'M-amount' } });
      
      checkAmountLimitA();
    }


    // --- (B) 承認待ち一覧機能 -------------------------------------------

    /**
     * (B) 承認待ち一覧をロード
     */
    function loadPendingReportsB() {
      showLoading(true, '承認待ち一覧を取得中...');
      google.script.run
        .withSuccessHandler(onLoadPendingReportsSuccessB)
        .withFailureHandler(onApiError)
        .getPendingReports();
    }

    /**
     * (B) 承認待ち一覧 取得成功 (v20: 修正)
     */
    function onLoadPendingReportsSuccessB(reports) {
      showLoading(false);
      var listBody = document.getElementById('B-approval-list-body');
      var badge = document.getElementById('approval-count-badge');
      listBody.innerHTML = '';
      
      if (!reports || reports.length === 0) {
        listBody.innerHTML = '<div class="list-group-item">承認待ちの申請はありません。</div>';
        badge.textContent = '';
        return;
      }

      badge.textContent = reports.length;
      
      reports.sort(function(a, b) {
        return (a['日付'] || '').localeCompare(b['日付'] || '');
      });
      
      reports.forEach(function(report) {
        var dateStr = report['日付'] || '日付不明';
        var formattedDate = '';
        try {
           formattedDate = new Date(dateStr.replace(/\//g, '-')).toLocaleDateString('ja-JP', { weekday: 'short' });
        } catch(e) { }
        
        var item = document.createElement('a');
        item.href = '#';
        item.className = 'list-group-item list-group-item-action d-flex justify-content-between align-items-center report-list-item';
        item.onclick = function(e) {
          e.preventDefault();
          loadReportDetailsC(report['経費ID'], 'view-B-approval-list');
        };
           
        item.innerHTML = 
          '<div>' +
            '<h5 class="mb-1">' + dateStr + ' (' + formattedDate + ')</h5>' +
            '<p class="mb-1">申請者: ' + (report['申請者'] || '不明') + '</p>' +
            '<p class="mb-0"><small>件名: ' + (report['件名'] || 'N/A') + '</small></p>' +
            '<small>合計経費: ' + formatNumber(report['合計経費'] || 0) + ' 円</small>' +
          '</div>' +
          '<i class="bi bi-chevron-right h4"></i>';
        
        listBody.appendChild(item);
      });
    }

    // --- (C) 詳細機能 (v20: 修正 / v21: 拡張) -----------------------------

    /**
     * (C) 詳細をロード
     */
    function loadReportDetailsC(reportId, returnViewId) {
      showLoading(true, '詳細を取得中...');
      viewC_ReturnView = returnViewId;
      
      google.script.run
        .withSuccessHandler(onLoadReportDetailsSuccessC)
        .withFailureHandler(onApiError)
        .getReportDetails(reportId);
    }
    
    /**
     * (C) 詳細 取得成功 (v20: 修正 / v21: エリア列追加) (要件3-5)
     */
    function onLoadReportDetailsSuccessC(data) {
      showLoading(false);
      
      if (!data || !data.header || !data.header['経費ID']) {
        console.error('onLoadReportDetailsSuccessC: Invalid data received.', data);
        onApiError('詳細データの取得に失敗しました。データが不正か、対象が見つかりません。');
        return;
      }

      var header = data.header;
      var expenses = data.expenses;

      // 1. ヘッダー
      document.getElementById('C-header-date').textContent = header['日付'] ?
        formatDateWithDay(header['日付']) : '日付なし';
      document.getElementById('C-header-applicant').textContent = header['申請者'] || '不明';
      document.getElementById('C-header-apply-date').textContent = header['申請日'] || 'N/A';
      document.getElementById('C-header-title').textContent = header['件名'] || 'N/A';
      document.getElementById('C-header-total-expense').textContent = formatNumber(header['合計経費'] || 0);
      document.getElementById('C-header-remarks').textContent = header['備考'] || '(備考なし)';
      
      var statusBadge = document.getElementById('C-header-status-badge');
      statusBadge.textContent = header['承認ステータス'];
      statusBadge.className = 'badge fs-6';
      switch (header['承認ステータス']) {
        case '申請中': statusBadge.classList.add('bg-primary'); break;
        case '承認済': statusBadge.classList.add('bg-success'); break;
        case '差戻し': statusBadge.classList.add('bg-danger'); break;
        case '一時保存': statusBadge.classList.add('bg-warning', 'text-dark'); break;
        case '精算申請済': statusBadge.classList.add('bg-info', 'text-dark'); break;
        default: statusBadge.classList.add('bg-secondary');
      }
      
      var reasonWrapper = document.getElementById('C-rejection-reason-wrapper');
      var reasonPre = document.getElementById('C-rejection-reason');
      if (header['差戻し理由']) {
        reasonPre.textContent = header['差戻し理由'];
        reasonWrapper.style.display = 'block';
      } else {
        reasonPre.textContent = '';
        reasonWrapper.style.display = 'none';
      }
      
      // 3. 経費明細
      var expBody = document.getElementById('C-expenses-body');
      expBody.innerHTML = '';
      if (expenses && expenses.length > 0) {
        expenses.forEach(function(ex) {
          var useDate = ex.useDate || 'N/A';
          var url = ex.receiptUrl;
          var urlLink = url ? '<a href="' + url + '" target="_blank" rel="noopener noreferrer"><i class="bi bi-box-arrow-up-right"></i></a>' : '';
          
          // (v21: ex.areaName はGAS側で設定済み)
          // (v24: ex.taxRate, ex.preTaxAmount もGAS側で設定済みだが、表示レイアウトは変更しない)
          expBody.innerHTML += 
            '<tr>' +
              '<td>' + useDate + '</td>' +
              '<td>' + (ex.itemName || '不明な項目') + '</td>' +
              '<td>' + (ex.areaName || '') + '</td>' + // (v21: 新規)
              '<td>' + formatNumber(ex.amount || 0) + '</td>' +
              '<td>' + (ex.remarks || '') + '</td>' +
              '<td>' + urlLink + '</td>' +
            '</tr>';
        });
      } else {
        expBody.innerHTML = '<tr><td colspan="6">経費明細はありません。</td></tr>'; // (v21: colspan=6)
      }
      
      // 4. 承認ボタンの制御
      var approvalButtons = document.getElementById('C-approval-buttons');
      if (IS_MANAGER && header['承認ステータス'] === '申請中' && viewC_ReturnView === 'view-B-approval-list') {
        document.getElementById('C-reportId').value = header['経費ID'];
        approvalButtons.style.display = 'block';
      } else {
        approvalButtons.style.display = 'none';
      }
      
      showView('view-C-report-detail');
    }

    /**
     * (C) 承認処理 (v18)
     */
    function handleApproveC() {
      var reportId = document.getElementById('C-reportId').value;
      if (!reportId) return;
      
      showCustomAlert('この申請を「承認」します。よろしいですか？', function() {
        showLoading(true, '承認処理中...');
        google.script.run
          .withSuccessHandler(function(result) {
            showLoading(false);
            showCustomAlert(result.message, function() {
              showView('view-B-approval-list');
            });
          })
          .withFailureHandler(onApiError)
          .approveReport(reportId);
      });
    }
    
    /**
     * (C) 差戻し処理 (v18)
     */
    function handleRejectC() {
      var reportId = document.getElementById('C-reportId').value;
      if (!reportId) return;
      
      showCustomPrompt('差戻し理由を入力してください（必須）:', function(reason) {
        if (!reason) {
          return;
        }
        
        showLoading(true, '差戻し処理中...');
        google.script.run
           .withSuccessHandler(function(result) {
            showLoading(false);
            showCustomAlert(result.message, function() {
              showView('view-B-approval-list');
            });
          })
           .withFailureHandler(onApiError)
          .rejectReport(reportId, reason);
      });
    }

    // --- (D) 経費精算まとめ機能 (v20: 修正 / v21: 拡張) -------------------

    /**
     * (D) 承認済みの経費一覧をロード
     */
    function loadApprovedExpensesD() {
      showLoading(true, '精算可能な申請を取得中...');
      google.script.run
        .withSuccessHandler(onLoadApprovedExpensesSuccessD)
        .withFailureHandler(onApiError)
        .getApprovedExpenses();
    }
    
    /**
     * (D) 承認済み経費 取得成功 (v20: 修正 / v21: エリア名追加) (要件3-5 準拠)
     */
    function onLoadApprovedExpensesSuccessD(data) {
      showLoading(false);
      var tbody = document.getElementById('D-expense-list-body');
      tbody.innerHTML = '';
      
      var reports = (data && data.reports) ? data.reports : [];
      var expenses = (data && data.expenses) ? data.expenses : [];
      
      if (reports.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="text-center">精算対象の「承認済」申請はありません。</td></tr>';
        updateTotalSelectedAmountD();
        return;
      }
      
      reports.sort(function(a, b) {
        return (a['日付'] || '').localeCompare(b['日付'] || '');
      });
      
      var expensesMap = {};
      expenses.forEach(function(ex) {
        var rId = ex['経費ID'];
        if (!expensesMap[rId]) {
          expensesMap[rId] = [];
        }
        
        // (v21: ex.areaName はGAS側で設定済み)
        var areaStr = ex.areaName ? ' (' + ex.areaName + ')' : '';
        // (v24: カンマ区切り)
        expensesMap[rId].push(ex.itemName + areaStr + ': ' + formatNumber(ex['金額']) + '円');
      });
      
      reports.forEach(function(report) {
        var tr = document.createElement('tr');
        var reportId = report['経費ID'];
        var totalExpense = parseFloat(report['合計経費']) || 0;
        var date = report['日付'];
        
        var expenseDetails = (expensesMap[reportId] || []).join('<br>');
        
        tr.innerHTML = 
          '<td>' +
            '<input class="form-check-input D-checkbox" type="checkbox" ' +
                    'value="' + reportId + '" ' +
                    'data-amount="' + totalExpense + '" ' +
                     'onchange="updateTotalSelectedAmountD()">' +
          '</td>' +
          '<td>' + date + '</td>' +
          '<td>' + (report['件名'] || 'N/A') + '</td>' +
          '<td>' + formatNumber(totalExpense) + '</td>' + // (v24: カンマ区切り)
          '<td><small>' + (expenseDetails || '(経費なし)') + '</small></td>' +
          '<td><small>' + String(reportId).substring(0, 8) + '...</small></td>';
        
        tbody.appendChild(tr);
      });
      
      updateTotalSelectedAmountD();
    }

    /**
     * (D) チェックボックス全選択/全解除
     */
    function toggleAllCheckboxesD(checked) {
      document.querySelectorAll('.D-checkbox').forEach(function(cb) {
        cb.checked = checked;
      });
      updateTotalSelectedAmountD();
    }
    
    /**
     * (D) 選択合計金額を更新
     */
    function updateTotalSelectedAmountD() {
      var total = 0;
      document.querySelectorAll('.D-checkbox:checked').forEach(function(cb) {
        total += parseFloat(cb.dataset.amount) || 0;
      });
      document.getElementById('D-total-selected-amount').textContent = formatNumber(total) + ' 円';
    }
    
    /**
     * (D) 最終精算申請を送信 (v18)
     */
    function submitFinalExpensesD() {
      var selectedIds = [];
      document.querySelectorAll('.D-checkbox:checked').forEach(function(cb) {
        selectedIds.push(cb.value);
      });
      
      if (selectedIds.length === 0) {
        showCustomAlert('精算申請する申請を選択してください。');
        return;
      }
      
      var confirmMessage = '選択した ' + selectedIds.length + ' 件の申請を経理に精算申請します。\nよろしいですか？';
      
      showCustomAlert(confirmMessage, function() {
        showLoading(true, '精算申請を送信中...');
        google.script.run
          .withSuccessHandler(function(result) {
            showLoading(false);
            showCustomAlert(result.message, function() {
              loadApprovedExpensesD();
            });
          })
          .withFailureHandler(onApiError)
          .submitFinalExpenses(selectedIds);
      });
    }

    // --- (E) 申請一覧機能 (v20: 修正 / v25: UI変更) ----------------------

    /**
     * (E) 自分の申請一覧をロード
     */
    function loadMyReportsE() {
      showLoading(true, '申請一覧を取得中...');
      google.script.run
        .withSuccessHandler(onLoadMyReportsSuccessE)
        .withFailureHandler(onApiError)
        .getMyReports();
    }

    /**
     * (E) 申請一覧 取得成功 (v25: グループ化UIに修正)
     * (v29: 修正) 件名・経費詳細・領収書URLの表示に対応
     */
    function onLoadMyReportsSuccessE(reports) {
      showLoading(false);
      var tbody = document.getElementById('E-my-reports-list-body');
      tbody.innerHTML = '';

      if (!reports || reports.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" class="text-center">申請データはありません。</td></tr>'; // (v29: colspan=8)
        return;
      }
      
      var currentStatus = ""; // (v25: グループ化のための現在ステータス)

      reports.forEach(function(report) {
        var rId = report['経費ID'];
        var status = report['承認ステータス'];

        // (v25: ステータスが変わったらヘッダー行を挿入)
        if (status !== currentStatus) {
          currentStatus = status;
          var headerTr = document.createElement('tr');
          headerTr.className = 'status-group-header'; // (v25: スタイル適用)
          // (v26: 修正) クラスを追加 (fs-6, py-2)
          headerTr.innerHTML = '<td colspan="8" class="fs-6 fw-bold ps-3 py-2">' + currentStatus + '</td>'; // (v29: colspan=8)
          tbody.appendChild(headerTr);
        }
        
        var statusBadge = '';
        switch (status) {
          case '申請中': statusBadge = '<span class="badge bg-primary">申請中</span>'; break;
          case '承認済': statusBadge = '<span class="badge bg-success">承認済</span>'; break;
          case '差戻し': statusBadge = '<span class="badge bg-danger">差戻し</span>'; break;
          case '一時保存': statusBadge = '<span class="badge bg-warning text-dark">一時保存</span>'; break;
          case '精算申請済': statusBadge = '<span class="badge bg-info text-dark">精算申請済</span>'; break;
          default: statusBadge = '<span class="badge bg-secondary">' + status + '</span>';
        }

        // (v25: 画像のUIに合わせる)
        var buttons = '';
        if (status === '一時保存' || status === '差戻し') {
          buttons = '<button class="btn btn-sm btn-primary" onclick="handleEditReportE(\'' + rId + '\')"><i class="bi bi-pencil"></i> 編集</button>';
        } else {
          buttons = '<button class="btn btn-sm btn-outline-secondary" onclick="loadReportDetailsC(\'' + rId + '\', \'view-E-my-reports\')"><i class="bi bi-eye"></i> 表示</button>';
        }

        // --- (v29: 追加) 経費詳細と領収書のHTMLを構築 ---
        var detailsHtml = '';
        var receiptsHtml = '';
        var reportDetails = report.details || []; // (v29) GASから渡された明細配列
        
        if (reportDetails.length > 0) {
          var detailsParts = [];
          var receiptParts = [];
          
          reportDetails.forEach(function(detail) {
            var areaStr = detail.areaName ? ' (' + detail.areaName + ')' : '';
            // 経費詳細: 項目名(エリア): 金額
            detailsParts.push(
              escapeHTML(detail.itemName) + areaStr + ': ' + formatNumber(detail.amount) + '円'
            );
            
            // 領収書: URLがあればリンク、なければ「なし」
            if (detail.receiptUrl) {
              receiptParts.push(
                '<a href="' + escapeHTML(detail.receiptUrl) + '" target="_blank" rel="noopener noreferrer"><i class="bi bi-box-arrow-up-right"></i></a>'
              );
            } else {
              receiptParts.push('なし');
            }
          });
          
          detailsHtml = '<small>' + detailsParts.join('<br>') + '</small>';
          receiptsHtml = '<small>' + receiptParts.join('<br>') + '</small>';
          
        } else {
          detailsHtml = '<small>(明細なし)</small>';
          receiptsHtml = '<small>(添付なし)</small>';
        }
        // --- (v29: 追加 終了) ---
        
        var tr = document.createElement('tr');
        
        // (v25: 列構成変更)
        // (v29: 列構成を8列に変更)
        tr.innerHTML = 
          '<td>' + (report['日付'] || '') + '</td>' +
          '<td>' + statusBadge + '</td>' +
          '<td><small>' + escapeHTML(report['件名']) + '</small></td>' +
          '<td>' + formatNumber(report['合計経費']) + '</td>' +
          '<td><small>' + escapeHTML(report['備考']) + '</small></td>' +
          '<td>' + detailsHtml + '</td>' +
          '<td>' + receiptsHtml + '</td>' +
          '<td>' + buttons + '</td>';
        
        tr.addEventListener('click', function(e) {
          if (!e.target.closest('button')) {
            loadReportDetailsC(rId, 'view-E-my-reports');
          }
        });
        
        tbody.appendChild(tr);
      });
    }
    
    /**
     * (E) 編集ボタンクリック時の処理 (v18)
     */
    function handleEditReportE(reportId) {
      showCustomAlert('この申請データを編集します。入力中の内容は破棄されますが、よろしいですか？', function() {
        showLoading(true, '編集データを読み込み中...');
        google.script.run
          .withSuccessHandler(onLoadReportForEditSuccessA)
          .withFailureHandler(onApiError)
          .getReportDataForEdit(reportId);
      });
    }
    
    /**
     * (A) 編集データの読み込み成功 (E -> A) (v20: 修正 / v21: 拡張 / v24: 税率読込) (要件3-4)
     */
    function onLoadReportForEditSuccessA(result) {
      showLoading(false);
      
      if (!result) {
        console.error('onLoadReportForEditSuccessA: Failed to load data. Result is null.');
        onApiError('編集データの読み込みに失敗しました。(result: null)');
        return;
      }
      
      if (result.status === 'success' && result.data && result.data.header && result.data.header['経費ID']) {
        var data = result.data;
        var h = data.header;
        
        resetFormA();
        
        // (v21: areaCodeも読み込まれる)
        // (v24: taxRate, preTaxAmount も読み込まれる)
        currentExpenses = data.expenses || [];

        renderExpenseListA();
        
        document.getElementById('A-reportId').value = h['経費ID'] || '';
        document.getElementById('A-date').value = h['日付'] ?
          h['日付'].replace(/\//g, '-') : getTodayString();
        document.getElementById('A-title').value = h['件名'] || '';
        document.getElementById('A-remarks').value = h['備考'] || '';
        
        var reasonDiv = document.getElementById('A-rejection-reason');
        if (h['差戻し理由']) {
          reasonDiv.textContent = '差戻し理由: ' + h['差戻し理由'];
          reasonDiv.style.display = 'block';
        } else {
          reasonDiv.style.display = 'none';
        }
        
        showView('view-A-expense-report');
      } else {
        var errorMsg = (result && result.message) ?
          result.message : '編集データの読み込みに失敗しました。(status: ' + (result.status || 'unknown') + ')';
        console.error('onLoadReportForEditSuccessA: Failed to load data.', result);
        onApiError(errorMsg);
      }
    }

  </script>
</body>
</html>
