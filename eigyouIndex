<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
  
  <title>日報兼経費精算システム</title>

  <style>
    /* 読み込み中オーバーレイ */
    #loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.6);
      z-index: 9998;
      display: none; /* 初期状態は非表示 */
      justify-content: center;
      align-items: center;
    }
    #loading-spinner {
      z-index: 9999;
      color: white;
      text-align: center;
    }

    /* ビューの切り替え */
    .app-view {
      display: none; /* すべてのビューを非表示 */
    }
    .app-view.active {
      display: block; /* activeクラスを持つビューのみ表示 */
    }

    /* タイムシート */
    .timesheet-table th, .timesheet-table td {
      vertical-align: middle;
      padding: 0.4rem;
    }
    .timesheet-table .time-col {
      width: 65px;
      font-size: 0.9rem;
      text-align: center;
      background-color: #f8f9fa; /* 時刻列に背景色を追加 */
    }
    .timesheet-table .type-col {
      width: 140px;
    }
    /* .timesheet-table .content-col {} */
    .timesheet-table .expense-col {
      width: 60px;
      text-align: center;
    }

    /* タイムシートの入力欄 (画像のデザインに寄せる) */
    .timesheet-table .form-control-sm,
    .timesheet-table .form-select-sm {
      border-radius: 0; /* 角を四角く */
      border: 1px solid #ced4da;
    }
    /* v5: datalist を使う input 用 */
    .timesheet-table .form-control-sm[list] {
      padding-right: 0.5rem; /* datalist の矢印スペースを考慮 (微調整) */
    }

    /* 経費ボタン (画像のデザインに寄せる) */
    .expense-button {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 30px; /* 円のサイズ */
      height: 30px; /* 円のサイズ */
      border-radius: 50%; /* 完全な円 */
      border: 1px solid #0d6efd;
      color: #0d6efd;
      background-color: #fff;
      font-size: 1.2rem; /* + のサイズ */
      line-height: 1;
      text-decoration: none;
      cursor: pointer;
    }
    .expense-button:hover {
      background-color: #0d6efd;
      color: #fff;
    }
    /* 経費が登録されたらボタンの色を変える */
    .expense-button.has-expense {
      background-color: #dc3545; /* 危険色 (赤) */
      border-color: #dc3545;
      color: #fff;
    }
    .expense-button.has-expense:hover {
      background-color: #b02a37;
      border-color: #b02a37;
    }
    .expense-button .expense-count {
      display: none; /* カウントは表示しない (仕様変更) */
    }


    /* 承認待ち一覧 (B) */
    .report-list-item {
      cursor: pointer;
    }
    .report-list-item:hover {
      background-color: #f8f9fa;
    }

    /* 日報一覧 (E) */
    #E-my-reports-list-body tr {
      cursor: pointer;
    }
    
    /* (v18 新規) カスタムモーダルはローディングより手前に表示 */
    .modal-backdrop {
      z-index: 10000;
    }
    .modal {
      z-index: 10001;
    }

    /* (v20 新規) 上限超過の警告 */
    .amount-over-limit {
      background-color: #fff3cd !important; /* Bootstrap の warning-subtle 色 */
      border-color: #ffc107;
    }
    
    /* (v24 新規) カンマ入力用。実際の number input を隠す */
    .hidden-number-input {
      display: none;
    }
    
  </style>
</head>
<body>

  <!-- ナビゲーションバー -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark sticky-top">
    <div class="container-fluid">
      <a class="navbar-brand" href="#"><i class="bi bi-calendar-check"></i> 日報システム</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <!-- ナビゲーションリンク (JSで動的生成) -->
        <ul class="navbar-nav me-auto mb-2 mb-lg-0" id="nav-links">
          <!-- (A) 日報入力 -->
          <li class="nav-item">
            <a class="nav-link" href="#" data-view="view-A-daily-report">
              <i class="bi bi-pencil-square"></i> 日報入力
            </a>
          </li>
          <!-- (E) 日報一覧 -->
          <li class="nav-item">
            <a class="nav-link" href="#" data-view="view-E-my-reports">
              <i class="bi bi-list-task"></i> 日報一覧
            </a>
          </li>
          <!-- (D) 経費精算 -->
          <li class="nav-item">
            <a class="nav-link" href="#" data-view="view-D-expense-summary">
              <i class="bi bi-cash-coin"></i> 経費精算
            </a>
          </li>
          <!-- (B) 承認待ち (管理者のみ) -->
          <? if (isManager) { ?>
          <li class="nav-item">
            <a class="nav-link" href="#" data-view="view-B-approval-list">
              <i class="bi bi-check2-circle"></i> 承認待ち
              <span class="badge bg-danger" id="approval-count-badge"></span>
            </a>
          </li>
          <? } ?>
        </ul>
        <div class="navbar-text text-white">
          <!-- (v15 修正) EMPLOYEE_INFO.employeeName -> EMPLOYEE_INFO.name -->
          <span id="user-info-display"></span> <i class="bi bi-person-circle"></i>
        </div>
      </div>
    </div>
  </nav>

  <!-- メインコンテナ -->
  <div class="container-fluid p-3 p-md-4">

    <!-- ===== (A) 日報入力ビュー ===== -->
    <div id="view-A-daily-report" class="app-view">
      <h3 class="mb-3"><i class="bi bi-pencil-square"></i> 日報入力・編集</h3>

      <!-- (v15 修正) 差戻し理由 表示欄 -->
      <div id="A-rejection-reason" class="alert alert-danger" style="display: none;"></div>

      <div class="card shadow-sm mb-4">
        <div class="card-body">
          <form id="report-header-form">
            <!-- 日報ID (隠しフィールド) -->
            <input type="hidden" id="A-reportId">
            
            <div class="row g-3">
              <div class="col-md-3">
                <label for="A-date" class="form-label">日付 <span class="text-danger">*</span></label>
                <input type="date" class="form-control" id="A-date" required>
              </div>
              <div class="col-md-9">
                <label for="A-remarks" class="form-label">備考（全体）</label>
                <input type="text" class="form-control" id="A-remarks" placeholder="本日の総括など">
              </div>
            </div>

            <hr>

            <h5 class="mt-3">メーター・走行距離</h5>
            <div class="row g-3 align-items-end">
              <div class="col-6 col-md-2">
                <label for="A-startMeter" class="form-label">始時メーター(km)</label>
                <input type="number" class="form-control" id="A-startMeter">
              </div>
              <div class="col-6 col-md-2">
                <label for="A-endMeter" class="form-label">終時メーター(km)</label>
                <input type="number" class="form-control" id="A-endMeter">
              </div>
              <div class="col-6 col-md-2">
                <label for="A-privateKm" class="form-label">私有走行(km)</label>
                <input type="number" class="form-control" id="A-privateKm" value="0">
              </div>
              <div class="col-6 col-md-3">
                <label class="form-label">本日の走行距離(km)</label>
                <h4 id="A-mileageDisplay" class="text-primary mb-0">0 km</h4>
              </div>
            </div>
            
            <!-- (v15 修正) 活動時間合計 表示欄 -->
            <hr>
            <h5 class="mt-3">活動時間 合計</h5>
            <div class="row g-3 align-items-end">
              <div class="col-6 col-md-3">
                <label class="form-label">移動時間 合計</label>
                <h4 id="A-totalMovementTime" class="text-info mb-0">0.0 時間</h4>
              </div>
              <div class="col-6 col-md-3">
                <label class="form-label">商談時間 合計</label>
                <h4 id="A-totalMeetingTime" class="text-info mb-0">0.0 時間</h4>
              </div>
            </div>
            
          </form>
        </div>
      </div>

      <!-- タイムシート -->
      <div class="card shadow-sm">
        <div class="card-header">
          タイムシート (7:00 〜 18:00)
        </div>
        <div class="table-responsive">
          <table class="table table-bordered table-hover timesheet-table mb-0">
            <thead class="table-light">
              <tr>
                <th class="time-col">時間</th>
                <th class="type-col">活動区分 <span class="text-danger">*</span></th>
                <th class="content-col">活動内容 (訪問先・業務内容)</th>
                <th class="expense-col">経費</th>
              </tr>
            </thead>
            <tbody id="A-timesheet-body">
              <!-- JSで動的生成 (renderTimesheetA) -->
            </tbody>
          </table>
        </div>
        <div class="card-footer text-center">
          <button type="button" class="btn btn-secondary" onclick="saveOrSubmitReportA('一時保存')">
            <i class="bi bi-save"></i> 一時保存
          </button>
          <button type="button" class="btn btn-primary" onclick="saveOrSubmitReportA('申請中')">
            <i class="bi bi-send-check"></i> 申請する
          </button>
          <button type="button" class="btn btn-outline-danger ms-3" onclick="resetFormA()">
            <i class="bi bi-arrow-clockwise"></i> 入力リセット
          </button>
        </div>
      </div>
      
      <!-- (v15 修正) 活動区分の datalist を更新 (休憩を追加) -->
      <datalist id="activity-types-list">
        <option value="出勤">
        <option value="退社">
        <option value="移動">
        <option value="商談">
        <option value="休憩"> <!-- 追加 -->
        <option value="その他">
      </datalist>

    </div>

    <!-- ===== (B) 承認待ち一覧ビュー ===== -->
    <div id="view-B-approval-list" class="app-view">
      <h3 class="mb-3"><i class="bi bi-check2-circle"></i> 承認待ち一覧</h3>
      <div class="card shadow-sm">
        <div class="list-group list-group-flush" id="B-approval-list-body">
          <!-- JSで動的生成 (loadPendingReportsB) -->
        </div>
      </div>
    </div>

    <!-- ===== (C) 日報詳細ビュー ===== -->
    <div id="view-C-report-detail" class="app-view">
      <h3 class="mb-3"><i class="bi bi-file-earmark-text"></i> 日報詳細</h3>
      
      <!-- 戻るボタン -->
      <button class="btn btn-outline-secondary mb-3" id="C-back-button">
        <i class="bi bi-arrow-left"></i> 戻る
      </button>

      <!-- ヘッダー情報 -->
      <div class="card shadow-sm mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h5 class="mb-0" id="C-header-date"></h5>
          <span class="badge fs-6" id="C-header-status-badge"></span>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-6">
              <strong>申請者:</strong> <span id="C-header-applicant"></span>
            </div>
            <div class="col-md-6">
              <strong>申請日:</strong> <span id="C-header-apply-date"></span>
            </div>
            <div class="col-md-6">
              <strong>走行距離:</strong> <span id="C-header-mileage"></span> km
            </div>
            <div class="col-md-6">
              <strong>合計経費:</strong> <span id="C-header-total-expense" class="text-danger fw-bold"></span> 円
            </div>
            
            <!-- v5 修正: 時間合計の表示欄を追加 -->
            <div class="col-md-6">
              <strong>移動時間合計:</strong> <span id="C-header-movement-time"></span> 時間
            </div>
            <div class="col-md-6">
              <strong>商談時間合計:</strong> <span id="C-header-meeting-time"></span> 時間
            </div>
            
            <div class="col-12 mt-2">
              <strong>備考:</strong> <pre id="C-header-remarks" class="bg-light p-2 rounded mb-0"></pre>
            </div>
            
            <!-- (v18 新規) 差戻し理由 (詳細画面) -->
            <div class="col-12 mt-2" id="C-rejection-reason-wrapper" style="display: none;">
              <strong>差戻し理由:</strong>
              <pre id="C-rejection-reason" class="bg-danger-subtle text-danger-emphasis p-2 rounded mb-0"></pre>
            </div>
          </div>
        </div>
      </div>

      <!-- 行動明細 -->
      <div class="card shadow-sm mb-4">
        <div class="card-header">行動明細</div>
        <div class="table-responsive">
          <table class="table table-striped mb-0">
            <thead class="table-light">
              <tr>
                <th>時間</th>
                <th>活動区分</th>
                <th>活動内容</th>
              </tr>
            </thead>
            <tbody id="C-activities-body">
              <!-- JSで動的生成 -->
            </tbody>
          </table>
        </div>
      </div>

      <!-- 経費明細 -->
      <div class="card shadow-sm mb-4">
        <div class="card-header">経費明細</div>
        <div class="table-responsive">
          <table class="table table-striped mb-0">
            <thead class="table-light">
              <tr>
                <!-- (v19 修正) 「時間帯」列を追加 -->
                <th>時間帯</th>
                <th>利用日</th>
                <th>経費項目</th>
                <th>金額 (円)</th>
                <!-- (v20 修正) エリア列を追加 -->
                <th>エリア</th>
                <!-- (v22 新規) 税関連の列を追加 -->
                <th>税抜金額 (円)</th>
                <th>税率</th>
                <th>備考</th>
                <th>領収書</th>
              </tr>
            </thead>
            <tbody id="C-expenses-body">
              <!-- JSで動G的生成 -->
            </tbody>
          </table>
        </div>
      </div>

      <!-- 承認/差戻しボタン (管理者のみ) -->
      <div id="C-approval-buttons" class="text-center" style="display: none;">
        <input type="hidden" id="C-reportId">
        <button class="btn btn-danger btn-lg" onclick="handleRejectC()">
          <i class="bi bi-x-circle"></i> 差戻し
        </button>
        <button class="btn btn-success btn-lg ms-3" onclick="handleApproveC()">
          <i class="bi bi-check-circle"></i> 承認する
        </button>
      </div>

    </div>

    <!-- ===== (D) 経費精算まとめビュー ===== -->
    <div id="view-D-expense-summary" class="app-view">
      <h3 class="mb-3"><i class="bi bi-cash-coin"></i> 経費精算まとめ</h3>
      
      <div class="alert alert-info">
        「承認済」ステータスで、まだ経費精算が申請されていない日報が表示されます。<br>
        対象を選択し、「精算申請を送信」ボタンを押してください。経理担当者に通知が送信されます。
      </div>

      <div class="card shadow-sm">
        <div class="card-header">
          <div class="d-flex justify-content-between align-items-center">
            <span>精算対象一覧</span>
            <button class="btn btn-sm btn-primary" onclick="submitFinalExpensesD()">
              <i class="bi bi-send-check"></i> 選択した日報の精算申請を送信
            </button>
          </div>
        </div>
        <div class="table-responsive">
          <table class="table table-hover mb-0">
            <thead class="table-light">
              <tr>
                <th style="width: 50px;">
                  <input class="form-check-input" type="checkbox" id="D-check-all" onchange="toggleAllCheckboxesD(this.checked)">
                </th>
                <th>日付</th>
                <th>合計経費 (円)</th>
                <th>経費詳細</th>
                <th>ID</th>
              </tr>
            </thead>
            <tbody id="D-expense-list-body">
              <!-- JSで動的生成 -->
            </tbody>
            <tfoot class="table-group-divider">
              <tr>
                <td colspan="2" class="text-end fw-bold">選択合計</td>
                <td class="fw-bold text-danger fs-5" id="D-total-selected-amount">0 円</td>
                <td colspan="2"></td>
              </tr>
            </tfoot>
          </table>
        </div>
      </div>
    </div>

    <!-- ===== (E) 日報一覧ビュー ===== -->
    <div id="view-E-my-reports" class="app-view">
      <h3 class="mb-3"><i class="bi bi-list-task"></i> 日報一覧 (自分)</h3>
      <div class="card shadow-sm">
        <div class="card-header">
          <div class="d-flex justify-content-between align-items-center">
            <span>自分の申請履歴</span>
            <button class="btn btn-sm btn-outline-primary" onclick="loadMyReportsE()">
              <i class="bi bi-arrow-clockwise"></i> 更新
            </button>
          </div>
        </div>
        <div class="table-responsive">
          <table class="table table-hover mb-0">
            <thead class="table-light">
              <tr>
                <th>日付</th>
                <th>ステータス</th>
                <th>合計経費 (円)</th>
                <th>備考</th>
                <th>操作</th>
              </tr>
            </thead>
            <tbody id="E-my-reports-list-body">
              <!-- JSで動的生成 -->
            </tbody>
          </table>
        </div>
      </div>
    </div>

  </div> <!-- /container-fluid -->


  <!-- 読み込み中オーバーレイ -->
  <div id="loading-overlay">
    <div id="loading-spinner">
      <div class="spinner-border" role="status" style="width: 3rem; height: 3rem;">
        <span class="visually-hidden">Loading...</span>
      </div>
      <h4 class="mt-3" id="loading-text">読み込み中...</h4>
    </div>
  </div>


  <!-- (A) 経費登録モーダル (v22: 税計算、OCR廃止) (v24: カンマ入力対応) -->
  <div class="modal fade" id="expenseModal" tabindex="-1" aria-labelledby="expenseModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="expenseModalLabel">経費登録</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="expense-form">
            <!-- 経費ID (編集用) -->
            <input type="hidden" id="M-expenseId">
            <!-- 紐づく時間 (バッジ更新用) -->
            <input type="hidden" id="M-timeSlot">
            
            <div class="row g-3">
              <!-- (v23 修正) col-md-6 -> col-12 -->
              <div class="col-12">
                <label for="M-useDate" class="form-label">利用日 <span class="text-danger">*</span></label>
                <input type="date" class="form-control" id="M-useDate" required>
              </div>
              <!-- (v23 修正) col-md-6 -> col-12 -->
              <div class="col-12">
                <label for="M-itemCode" class="form-label">経費項目 <span class="text-danger">*</span></label>
                <select class="form-select" id="M-itemCode" required>
                  <option value="">選択してください</option>
                  <!-- JSで動的生成 (loadExpenseItems) -->
                </select>
              </div>

              <!-- (v20 新規) エリア選択 (v23 修正) col-md-6 -> col-12 -->
              <div class="col-12" id="M-area-wrapper" style="display: none;">
                <label for="M-areaCode" class="form-label">エリア <span class="text-danger">*</span></label>
                <select class="form-select" id="M-areaCode">
                  <option value="">エリアを選択</option>
                  <!-- JSで動的生成 (loadLodgingAreasMasterA) -->
                </select>
              </div>

              <!-- (v22 修正) 金額 (税込) (v23 修正) col-md-6 -> col-12 -->
              <div class="col-12">
                <label for="M-amount" class="form-label">金額 (円) <span class="text-danger">*</span></label>
                <!-- (v24 変更) 実際の入力欄 (カンマ表示用) -->
                <input type="tel" class="form-control" id="M-amount-display-input" placeholder="税込金額" inputmode="numeric">
                <!-- (v24 変更) データを保持する number input (隠す) -->
                <input type="number" class="hidden-number-input" id="M-amount" required>
                <!-- (v20) 上限表示用 (v23: 削除) -->
                <!-- (v22) カンマ区切り表示用 (v23: 削除 -> v24: input 自体にカンマを振るため不要) -->
                <!-- <div id="M-amount-display" class="form-text text-muted"></div> -->
              </div>
              
              <!-- (v22 新規) 消費税率 (v23 修正) col-md-6 -> col-12 / 順序変更 -->
              <div class="col-12">
                <label for="M-tax-rate-select" class="form-label">消費税率</label>
                <div class="input-group">
                  <select class="form-select" id="M-tax-rate-select">
                    <option value="auto">---</option>
                    <option value="10">10%</option>
                    <option value="8">8%</option>
                    <option value="5">5%</option>
                    <option value="3">3%</option>
                    <option value="0">消費税なし</option>
                    <option value="custom">その他 (手入力)</option>
                  </select>
                  <input type="number" class="form-control" id="M-tax-rate-custom" placeholder="例: 10" style="display: none;" min="0">
                </div>
              </div>

              <!-- (v22 新規) 税抜金額 (v23 修正) col-md-6 -> col-12 / 順序変更 -->
              <div class="col-12">
                <label for="M-amount-excluding-tax" class="form-label">税抜金額 (円)</label>
                <!-- (v24 変更) 実際の入力欄 (カンマ表示用) -->
                <input type="tel" class="form-control" id="M-amount-excluding-tax-display-input" placeholder="税抜金額" inputmode="numeric">
                <!-- (v24 変更) データを保持する number input (隠す) -->
                <input type="number" class="hidden-number-input" id="M-amount-excluding-tax">
                <!-- (v22) カンマ区切り表示用 (v23: 削除 -> v24: input 自体にカンマを振るため不要) -->
                <!-- <div id="M-amount-excluding-tax-display" class="form-text text-muted"></div> -->
              </div>
              
              <div class="col-12">
                <label for="M-remarks" class="form-label">備考（内容・訪問先など）</label>
                <input type="text" class="form-control" id="M-remarks" placeholder="例: 駐車代 (〇〇商事様)">
              </div>
              
              <hr class="my-2">
              
              <!-- (v22 修正) AI-OCR 関連を削除 -->
              <div class="col-12">
                <label for="M-receiptImage" class="form-label">領収書アップロード</label>
                <!-- (v22) "accept" を "image/*" に -->
                <!-- (v24 変更) "capture" 属性を削除 (カメラ + フォルダ選択) -->
                <input class="form-control" type="file" id="M-receiptImage" accept="image/*">
                <!-- (v24 削除) （スマホの場合、カメラが起動します）のテキストを削除 -->
                <!-- <div class="form-text">（スマホの場合、カメラが起動します）</div> -->
              </div>
              
              <!-- (v22 削除) M-ocr-status は削除 -->
              <!-- <div id="M-ocr-status" class="mt-2"></div> -->
              
              <div class="col-12">
                <label for="M-receiptUrl" class="form-label">領収書URL</label>
                <!-- (v22 変更) readonly を維持し、placeholder を追加 -->
                <input type="text" class="form-control" id="M-receiptUrl" readonly placeholder="アップロードするとここにURLが表示されます">
              </div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <!-- (v19 修正) 削除ボタンを追加 -->
          <button type="button" class="btn btn-outline-danger me-auto" id="M-delete-expense" onclick="deleteExpenseItemA()" style="display: none;">
            <i class="bi bi-trash"></i> 削除
          </button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">閉じる</button>
          <button type="button" class="btn btn-primary" onclick="addExpenseItemA()">
            <i class="bi bi-check-lg"></i> この内容で登録
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- (v18 新規) カスタムAlertモーダル -->
  <div class="modal fade" id="customAlertModal" tabindex="-1" aria-labelledby="customAlertModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="customAlertModalLabel">情報</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p id="customAlertMessage"></p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-primary" data-bs-dismiss="modal" id="customAlertOkButton">OK</button>
        </div>
      </div>
    </div>
  </div>

  <!-- (v18 新規) カスタムPromptモーダル (差戻し理由用) -->
  <div class="modal fade" id="customPromptModal" tabindex="-1" aria-labelledby="customPromptModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="customPromptModalLabel">差戻し理由</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <label for="customPromptInput" class="form-label" id="customPromptMessage">差戻し理由を入力してください（必須）:</label>
          <textarea class="form-control" id="customPromptInput" rows="3"></textarea>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
          <button type="button" class="btn btn-primary" id="customPromptOkButton">OK</button>
        </div>
      </div>
    </div>
  </div>


  <!-- Bootstrap 5 JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <!-- クライアントサイド JavaScript (ES5準拠) (v22: 税計算、OCR廃止) (v24: カンマ入力対応) -->
  <script>
    // --- グローバル変数 -------------------------------------------------
    
    // GASから渡されるデータ
    var EMPLOYEE_INFO = <?!= employeeInfo ?>;
    var IS_MANAGER = <?!= isManager ?>; // Boolean (GASから渡されます)
    var EXPENSE_ITEMS_MASTER = <?!= expenseItems ?>;
    var TRAVEL_RULES_MASTER = <?!= travelRules ?>; // v20: 追加
    var LODGING_AREAS_MASTER = <?!= lodgingAreas ?>; // v20: 追加
    // v21: 追加マスタ
    var JOB_CATEGORIES_MASTER = <?!= jobCategories ?>;
    var POSITIONS_MASTER = <?!= positions ?>;
    var DEPARTMENTS_MASTER = <?!= departments ?>;
    
    // (A) 日報入力用データ
    var currentActivities = {}; // { "07:00": { type: "...", content: "..." }, ... }
    var currentExpenses = [];   // [ { expenseId, timeSlot, itemCode, ... }, ... ]
    
    // (A) タイムシートの定義
    var TIME_SLOTS = [
      "07:00", "07:30", "08:00", "08:30", "09:00", "09:30",
      "10:00", "10:30", "11:00", "11:30", "12:00", "12:30",
      "13:00", "13:30", "14:00", "14:30", "15:00", "15:30",
      "16:00", "16:30", "17:00", "17:30", "18:00"
    ];
    // ※ 18:00 は "18:00-18:30" の開始時刻として定義。終了時刻は "18:30" まで。

    // (A) 経費モーダルのインスタンス
    var expenseModalInstance;

    // (C) 詳細画面の遷移元
    var viewC_ReturnView = 'view-E-my-reports'; // デフォルトは一覧(E)
    
    // (v18 新規) カスタムモーダルのインスタンスとコールバック
    var customAlertModalInstance;
    var customPromptModalInstance;
    var customAlertCallback = null;
    var customPromptCallback = null;

    // (v20 新規) 現在の経費上限額
    var currentExpenseLimit = null;


    // --- 初期化 -------------------------------------------------------

    /**
     * DOM読み込み完了時の初期化処理
     */
    document.addEventListener('DOMContentLoaded', function() {
      // ユーザー情報表示 (v15 修正)
      document.getElementById('user-info-display').textContent = EMPLOYEE_INFO.name || 'ゲスト';
      
      // ナビゲーションの初期化
      buildNavigation();
      
      // (A) 経費モーダルの初期化
      expenseModalInstance = new bootstrap.Modal(document.getElementById('expenseModal'));
      document.getElementById('expenseModal').addEventListener('shown.bs.modal', onExpenseModalShowA);
      document.getElementById('expenseModal').addEventListener('hidden.bs.modal', onExpenseModalHideA);
      
      // (v18 新規) カスタムモーダルの初期化
      initializeCustomModalsA();

      // (A) 経費モーダルの項目マスタ読み込み
      loadExpenseItemsMasterA();
      
      // (v20 新規) 宿泊エリアマスタ読み込み
      loadLodgingAreasMasterA();

      // (A) タイムシートの初期描画
      renderTimesheetA();

      // (A) メーター自動計算のイベントリスナー設定
      setupMileageCalculatorA();

      // (A) 領収書アップロードのイベントリスナー設定 (v22: AI-OCR廃止)
      document.getElementById('M-receiptImage').addEventListener('change', handleImageUploadA);
      
      // (v20 新規) 経費モーダルのロジック用イベントリスナー
      document.getElementById('M-itemCode').addEventListener('change', onItemCodeChangeA);
      document.getElementById('M-areaCode').addEventListener('change', onAreaCodeChangeA);
      document.getElementById('M-amount').addEventListener('input', checkExpenseLimitA);
      
      // (v22 新規) 税計算用のイベントリスナー
      // (v24 変更) 実際のデータinput ('M-amount') をトリガーにする
      document.getElementById('M-amount').addEventListener('input', handleTaxCalculationA);
      document.getElementById('M-amount-excluding-tax').addEventListener('input', handleTaxCalculationA);
      document.getElementById('M-tax-rate-select').addEventListener('change', handleTaxCalculationA);
      document.getElementById('M-tax-rate-custom').addEventListener('input', handleTaxCalculationA);

      // (v24 新規) カンマ入力のイベントリスナー設定
      initializeKanmaInputsA();

      // (C) 詳細画面の戻るボタン
      document.getElementById('C-back-button').addEventListener('click', function() {
        showView(viewC_ReturnView);
      });
      
      // デフォルトビューの表示 (日報入力を最初に表示)
      showView('view-A-daily-report');
    });

    /**
     * ナビゲーションバーのリンクとイベントリスナーを設定
     */
    function buildNavigation() {
      var navLinks = document.getElementById('nav-links');
      
      navLinks.querySelectorAll('.nav-link').forEach(function(link) {
        link.addEventListener('click', function(e) {
          e.preventDefault();
          var viewId = e.currentTarget.dataset.view;
          showView(viewId);
          
          // Bootstrap 5 のトグルを閉じる
          var navbar = document.getElementById('navbarNav');
          var bsCollapse = bootstrap.Collapse.getInstance(navbar);
          if (bsCollapse && navbar.classList.contains('show')) {
            bsCollapse.hide();
          }
        });
      });
    }

    /**
     * (A) 経費モーダルの項目マスタを読み込む
     */
    function loadExpenseItemsMasterA() {
      var select = document.getElementById('M-itemCode');
      select.innerHTML = '<option value="">選択してください</option>'; // 初期化
      
      EXPENSE_ITEMS_MASTER.forEach(function(item) {
        var option = document.createElement('option');
        option.value = item['経費項目コード'];
        option.textContent = item['経費項目'];
        select.appendChild(option);
      });
    }
    
    /**
     * (A) (v20 新規) 宿泊エリアマスタを読み込む
     */
    function loadLodgingAreasMasterA() {
      var select = document.getElementById('M-areaCode');
      select.innerHTML = '<option value="">エリアを選択</option>'; // 初期化
      
      LODGING_AREAS_MASTER.forEach(function(area) {
        var option = document.createElement('option');
        option.value = area['地域区分'];
        option.textContent = area['地域区分名'];
        select.appendChild(option);
      });
    }


    // --- 汎用: ビュー切り替え & UI ------------------------------------

    /**
     * (v18 新規) カスタムAlert/Promptモーダルの初期化
     */
    function initializeCustomModalsA() {
      var alertModalEl = document.getElementById('customAlertModal');
      customAlertModalInstance = new bootstrap.Modal(alertModalEl);
      
      // Alertモーダルが閉じたときにコールバックを実行
      alertModalEl.addEventListener('hidden.bs.modal', function() {
        if (typeof customAlertCallback === 'function') {
          customAlertCallback();
          customAlertCallback = null; // コールバックをリセット
        }
      });

      var promptModalEl = document.getElementById('customPromptModal');
      customPromptModalInstance = new bootstrap.Modal(promptModalEl);
      
      // PromptのOKボタン
      document.getElementById('customPromptOkButton').addEventListener('click', function() {
        var value = document.getElementById('customPromptInput').value;
        if (typeof customPromptCallback === 'function') {
          customPromptCallback(value); // 入力値を渡す
          customPromptCallback = null; // コールバックをリセット
        }
        customPromptModalInstance.hide();
      });
      
      // Promptが閉じたとき（キャンセル含む）
      promptModalEl.addEventListener('hidden.bs.modal', function() {
        if (typeof customPromptCallback === 'function') {
          customPromptCallback(null); // キャンセル時は null を渡す
          customPromptCallback = null;
        }
      });
    }
    
    /**
     * (v18 新規) カスタムAlertを表示 (alert() の代替)
     * @param {string} message 表示するメッセージ
     * @param {function} [callback] OKボタンを押した後のコールバック
     */
    function showCustomAlert(message, callback) {
      document.getElementById('customAlertMessage').textContent = message;
      document.getElementById('customAlertModalLabel').textContent = '情報'; // デフォルトタイトル
      
      // エラーメッセージの場合、タイトルを変更
      if (message.indexOf('エラー') > -1 || message.indexOf('失敗') > -1) {
         document.getElementById('customAlertModalLabel').textContent = 'エラー';
      }
      
      customAlertCallback = callback || null;
      customAlertModalInstance.show();
    }
    
    /**
     * (v18 新規) カスタムPromptを表示 (prompt() の代替)
     * @param {string} message ラベルとして表示するメッセージ
     * @param {function} callback (value) => {} OKなら入力値、キャンセルならnull
     */
    function showCustomPrompt(message, callback) {
      document.getElementById('customPromptMessage').textContent = message;
      document.getElementById('customPromptInput').value = ''; // 入力欄をクリア
      customPromptCallback = callback;
      customPromptModalInstance.show();
    }
    

    /**
     * 指定されたIDのビューを表示し、他を非表示にする
     * @param {string} viewId 表示するビューのID
     */
    function showView(viewId) {
      // すべてのビューを非表示
      document.querySelectorAll('.app-view').forEach(function(view) {
        view.classList.remove('active');
      });

      // ナビゲーションのアクティブ状態を更新
      document.querySelectorAll('#nav-links .nav-link').forEach(function(link) {
        if (link.dataset.view === viewId) {
          link.classList.add('active');
        } else {
          link.classList.remove('active');
        }
      });
      
      // 対象のビューを表示
      var targetView = document.getElementById(viewId);
      if (targetView) {
        targetView.classList.add('active');
        
        // ビュー表示時のロード処理
        switch (viewId) {
          case 'view-A-daily-report':
            // 日報入力画面表示時 (日付が空なら今日の日付をセット)
            if (!document.getElementById('A-date').value) {
              document.getElementById('A-date').value = getTodayString();
            }
            break;
          case 'view-B-approval-list':
            loadPendingReportsB();
            break;
          case 'view-D-expense-summary':
            loadApprovedExpensesD();
            break;
          case 'view-E-my-reports':
            loadMyReportsE();
            break;
        }
      } else {
        console.error('View not found: ' + viewId);
      }
    }

    /**
     * ローディングオーバーレイの表示/非表示
     * @param {boolean} show 表示フラグ
     * @param {string} [text] 表示テキスト
     */
    function showLoading(show, text) {
      text = text || '読み込み中...'; // デフォルト引数の代替
      var overlay = document.getElementById('loading-overlay');
      document.getElementById('loading-text').textContent = text;
      overlay.style.display = show ? 'flex' : 'none';
    }

    /**
     * 汎用APIエラーハンドラ (v18 修正: カスタムアラート)
     * @param {Error | string} error エラーオブジェクトまたはメッセージ
     */
    function onApiError(error) {
      showLoading(false); // ローディングを非表示
      
      var message = '不明なエラーが発生しました。';
      
      if (typeof error === 'string') {
        message = error;
      } else if (error && error.message) {
        // v10 修正: GAS側で new Error() したエラー
        var gasErrorMsg = error.message.split('->').pop();
        message = gasErrorMsg ? gasErrorMsg.trim() : error.message;
      }

      console.error('API Error:', error);
      showCustomAlert('エラーが発生しました:\n' + message); // (v18 修正)
    }

    /**
     * 今日の日付を "YYYY-MM-DD" 形式で取得 (input[type=date]用)
     */
    function getTodayString() {
      var today = new Date();
      today.setHours(today.getHours() + 9); // JST補正
      return today.toISOString().split('T')[0];
    }
    
    /**
     * 数値をカンマ区切りにフォーマット
     */
    function formatNumber(num) {
      return (num || 0).toLocaleString();
    }
    
    /**
     * 小数点第1位までに丸める (v15 修正)
     */
    function formatHours(hours) {
      return (Math.round((hours || 0) * 10) / 10).toFixed(1); // v15: 少数第1位に変更
    }
    
    /**
     * (v17 新規) "yyyy-MM-dd" または "yyyy/MM/dd" を "yyyy/MM/dd (曜)" に変換
     */
    function formatDateWithDay(dateStr) {
      if (!dateStr) return '日付不明';
      try {
        // ハイフンをスラッシュに置換して Date オブジェクトを生成
        var date = new Date(dateStr.replace(/-/g, '/'));
        var yyyy = date.getFullYear();
        var mm = ('0' + (date.getMonth() + 1)).slice(-2);
        var dd = ('0' + date.getDate()).slice(-2);
        var day = ['日', '月', '火', '水', '木', '金', '土'][date.getDay()];
        return yyyy + '/' + mm + '/' + dd + ' (' + day + ')';
      } catch (e) {
        return dateStr; // 変換失敗時はそのまま返す
      }
    }


    // --- (A) 日報入力機能 ----------------------------------------------

    /**
     * (A) タイムシートを描画する (v18 修正: バッジ更新削除)
     */
    function renderTimesheetA() {
      var tbody = document.getElementById('A-timesheet-body');
      tbody.innerHTML = ''; // 既存の内容をクリア

      for (var i = 0; i < TIME_SLOTS.length - 1; i++) { // 最後の "18:00" は次の開始時刻なのでループ対象外
        var startTime = TIME_SLOTS[i];
        var endTime = TIME_SLOTS[i+1];
        
        // 復元データ
        var activity = currentActivities[startTime] || { type: '', content: '' };
        
        var tr = document.createElement('tr');
        
        // 時間
        tr.innerHTML = '<th class="time-col table-light">' + startTime + '</th>';
        
        // (v5 修正) 活動区分 (select -> input+datalist)
        var tdType = document.createElement('td');
        tdType.className = 'type-col';
        var inputType = document.createElement('input');
        inputType.type = 'text';
        inputType.className = 'form-control form-control-sm A-activity-type';
        inputType.setAttribute('list', 'activity-types-list'); // datalist を紐付け
        inputType.dataset.time = startTime;
        inputType.value = activity.type;
        // イベントリスナー (活動区分)
        inputType.addEventListener('input', function(e) {
          updateActivityA(e.target.dataset.time, 'type', e.target.value);
        });
        // 自動補完 (フォーカスアウト時)
        inputType.addEventListener('focusout', autoFillMovementA);
        tdType.appendChild(inputType);
        tr.appendChild(tdType);

        // 活動内容
        var tdContent = document.createElement('td');
        tdContent.className = 'content-col';
        var inputContent = document.createElement('input');
        inputContent.type = 'text';
        inputContent.className = 'form-control form-control-sm A-activity-content';
        inputContent.dataset.time = startTime;
        inputContent.placeholder = '活動内容 (例: 〇〇商事様 商談)';
        inputContent.value = activity.content;
        // イベントリスナー (活動内容)
        inputContent.addEventListener('input', function(e) {
          updateActivityA(e.target.dataset.time, 'content', e.target.value);
        });
        tdContent.appendChild(inputContent);
        tr.appendChild(tdContent);

        // 経費 (スタイル変更)
        var tdExpense = document.createElement('td');
        tdExpense.className = 'expense-col';
        tdExpense.innerHTML = 
          '<span class="expense-button" ' +
                'id="expense-badge-' + startTime + '" ' +
                'onclick="openExpenseModalA(\'' + startTime + '\')">' +
            '<i class="bi bi-plus"></i>' + // bi-plus-lg から bi-plus に変更
            '<span class="expense-count" id="expense-count-' + startTime + '">0</span>' + // カウントはCSSで非表示
          '</span>';
        tr.appendChild(tdExpense);
        
        tbody.appendChild(tr);
      }
      
      // (v18 修正) 経費バッジの更新は onLoadReportForEditSuccessA 側で実行するため、ここから削除
      // updateAllExpenseBadgesA(); 
    }

    /**
     * (A) フォーム(A)全体をリセットする (v18 修正: バッジ更新削除)
     */
    function resetFormA() {
      document.getElementById('report-header-form').reset();
      document.getElementById('A-reportId').value = '';
      document.getElementById('A-date').value = getTodayString();
      document.getElementById('A-mileageDisplay').textContent = '0 km';
      
      // (v15 修正) 時間合計表示をリセット
      document.getElementById('A-totalMovementTime').textContent = '0.0 時間';
      document.getElementById('A-totalMeetingTime').textContent = '0.0 時間';
      
      // (v15 修正) 差戻し理由を非表示
      var reasonDiv = document.getElementById('A-rejection-reason');
      reasonDiv.textContent = '';
      reasonDiv.style.display = 'none';
      
      currentActivities = {};
      currentExpenses = [];
      
      // タイムシートの入力内容をリセット
      document.querySelectorAll('.A-activity-type').forEach(function(el) { el.value = ''; });
      document.querySelectorAll('.A-activity-content').forEach(function(el) { el.value = ''; });
      
      // (v18 修正) 経費バッジをリセット
      // updateAllExpenseBadgesA(); // ここで呼ぶと onLoadReportForEditSuccessA で問題が起きるため削除
      // (v18) 代わりに手動でバッジをクリア
      document.querySelectorAll('.expense-button').forEach(function(badge) {
        badge.classList.remove('has-expense');
      });
    }

    /**
     * (A) 走行距離計算のイベントリスナーを設定
     */
    function setupMileageCalculatorA() {
      var inputs = ['A-startMeter', 'A-endMeter', 'A-privateKm'];
      inputs.forEach(function(id) {
        document.getElementById(id).addEventListener('input', calculateMileageA);
      });
    }

    /**
     * (A) 走行距離を計算して表示
     */
    function calculateMileageA() {
      var start = parseFloat(document.getElementById('A-startMeter').value) || 0;
      var end = parseFloat(document.getElementById('A-endMeter').value) || 0;
      var privateKm = parseFloat(document.getElementById('A-privateKm').value) || 0;
      
      var mileage = 0;
      if (end > start) {
        mileage = (end - start) - privateKm;
      }
      
      document.getElementById('A-mileageDisplay').textContent = Math.max(0, mileage) + ' km';
    }

    /**
     * (A) currentActivities オブジェクトを更新 (v15 修正)
     * @param {string} timeSlot "07:00" など
     * @param {'type' | 'content'} key 'type' または 'content'
     * @param {string} value 入力値
     */
    function updateActivityA(timeSlot, key, value) {
      if (!currentActivities[timeSlot]) {
        currentActivities[timeSlot] = { type: '', content: '' };
      }
      currentActivities[timeSlot][key] = value;
      
      // (v15 修正) 活動時間をリアルタイム計算
      calculateTotalsA();
    }

    /**
     * (A) 活動と活動の間の空白行に "移動" を自動補完する
     */
    function autoFillMovementA() {
      var allTypes = document.querySelectorAll('.A-activity-type');
      var firstActivityIdx = -1;
      var lastActivityIdx = -1;
      
      // 最初と最後の活動インデックスを探す
      allTypes.forEach(function(select, index) {
        if (select.value !== '') {
          if (firstActivityIdx === -1) {
            firstActivityIdx = index;
          }
          lastActivityIdx = index;
        }
      });
      
      if (firstActivityIdx === -1) return; // 活動が入力されていない

      // 最初と最後の間をループ
      for (var i = firstActivityIdx + 1; i < lastActivityIdx; i++) {
        if (allTypes[i].value === '') { // 空白行
          allTypes[i].value = '移動';
          // currentActivities にも反映
          updateActivityA(allTypes[i].dataset.time, 'type', '移動');
        }
      }
    }
    
    /**
     * (A) (v15 新規) 活動時間（移動・商談）を計算して表示
     */
    function calculateTotalsA() {
      var totalMovementHours = 0;
      var totalMeetingHours = 0;
      
      // currentActivities (オブジェクト) をループ
      var keys = Object.keys(currentActivities);
      keys.forEach(function(timeSlot) {
        var act = currentActivities[timeSlot];
        if (act && act.type) {
          // 1枠 = 30分 = 0.5時間
          if (act.type === '移動') {
            totalMovementHours += 0.5;
          } else if (act.type === '商談') {
            totalMeetingHours += 0.5;
          }
        }
      });
      
      // HTMLに反映
      document.getElementById('A-totalMovementTime').textContent = totalMovementHours.toFixed(1) + ' 時間';
      document.getElementById('A-totalMeetingTime').textContent = totalMeetingHours.toFixed(1) + ' 時間';
    }


    /**
     * (A) 経費モーダルを開く (v20 修正: 編集ロジック・規定ロジック) (v22: 税項目) (v24: カンマ入力)
     * @param {string} timeSlot "07:00" など
     */
    function openExpenseModalA(timeSlot) {
      // モーダルフォームをリセット
      document.getElementById('expense-form').reset();
      document.getElementById('M-expenseId').value = '';
      document.getElementById('M-timeSlot').value = timeSlot; // 紐づく時間をセット
      
      // (v22 修正) OCRステータス -> URL欄
      document.getElementById('M-receiptUrl').value = '';
      document.getElementById('M-receiptUrl').placeholder = 'アップロードするとここにURLが表示されます';
      
      // (v20) 規定ロジック・UIをリセット
      document.getElementById('M-area-wrapper').style.display = 'none';
      document.getElementById('M-areaCode').required = false;
      document.getElementById('M-areaCode').value = '';
      // (v23: 削除) document.getElementById('M-amount-limit-note').textContent = '';
      currentExpenseLimit = null;
      checkExpenseLimitA(); // 背景色をリセット
      
      // (v22 新規) 税・カンマ表示をリセット
      // (v23: 削除) updateAmountDisplayA('M-amount');
      // (v24 変更) カンマ入力欄をリセット
      updateKanmaInputA('M-amount', '');
      updateKanmaInputA('M-amount-excluding-tax', '');
      document.getElementById('M-tax-rate-select').value = 'auto';
      toggleCustomTaxRateA(); // 手入力欄を非表示
      
      // (v19 修正) 削除ボタン
      var deleteButton = document.getElementById('M-delete-expense');
      
      // (v19 修正) この時間枠に既存の経費があるか検索
      // TODO: 現状は1枠1経費のみ対応
      var expenseToEdit = currentExpenses.find(function(ex) {
        return ex.timeSlot === timeSlot;
      });
      
      if (expenseToEdit) {
        // 経費が見つかった場合 (編集モード)
        document.getElementById('M-expenseId').value = expenseToEdit.expenseId;
        // (v19 修正) 日付は yyyy/MM/dd (GAS) または yyyy-MM-dd (JS) のため、- に統一
        document.getElementById('M-useDate').value = expenseToEdit.useDate.replace(/\//g, '-');
        document.getElementById('M-itemCode').value = expenseToEdit.itemCode;
        // document.getElementById('M-amount').value = expenseToEdit.amount; // (v20) onchangeロジックでセット
        document.getElementById('M-remarks').value = expenseToEdit.remarks;
        document.getElementById('M-receiptUrl').value = expenseToEdit.receiptUrl;
        document.getElementById('M-areaCode').value = expenseToEdit.areaCode || ''; // (v20)
        
        // (v22 新規) 税項目を復元
        document.getElementById('M-tax-rate-select').value = expenseToEdit.taxRate || 'auto';
        document.getElementById('M-tax-rate-custom').value = expenseToEdit.taxRateCustom || '';

        deleteButton.style.display = 'inline-block'; // 削除ボタン表示
        
        // (v20) 編集読み込み時のロジック実行
        // 1. 項目変更イベントを強制発火 (エリア表示/非表示、上限額セット)
        onItemCodeChangeA(); 
        // 2. 金額を上書き (onItemCodeChangeA が初期値をセットするため)
        // (v24 変更) カンマ入力更新用の関数を使用
        updateKanmaInputA('M-amount', expenseToEdit.amount);
        // 3. 上限チェックを強制発火 (読み込んだ金額で背景色を判定)
        checkExpenseLimitA();
        
        // (v22 新規) 読み込み後に税計算・カンマ表示を強制実行
        // (v24 変更) カンマ入力更新用の関数を使用
        updateKanmaInputA('M-amount-excluding-tax', expenseToEdit.taxExcludedAmount);
        handleTaxCalculationA({ target: { id: 'M-amount' } });

      } else {
        // 経費がない場合 (新規モード)
        // 利用日は日報の日付をデフォルトセット
        document.getElementById('M-useDate').value = document.getElementById('A-date').value || getTodayString();
        deleteButton.style.display = 'none'; // 削除ボタン非表示
        // (v20) 新規の場合、onItemCodeChangeA はユーザーが選択するまで待機
      }
      
      expenseModalInstance.show();
    }
    
    /**
     * (A) 経費モーダル表示時の処理
     */
    function onExpenseModalShowA() {
      // (必要に応じて)
    }

    /**
     * (A) 経費モーダル非表示時の処理 (v20, v22, v24 修正)
     */
    function onExpenseModalHideA() {
      // フォームとファイルインプットをクリア
      document.getElementById('expense-form').reset();
      document.getElementById('M-receiptImage').value = ''; // fileインプットもクリア
      document.getElementById('M-delete-expense').style.display = 'none'; // (v19)
      
      // (v20) 規定ロジック・UIをリセット
      document.getElementById('M-area-wrapper').style.display = 'none';
      document.getElementById('M-areaCode').required = false;
      document.getElementById('M-areaCode').value = '';
      // (v23: 削除) document.getElementById('M-amount-limit-note').textContent = '';
      currentExpenseLimit = null;
      checkExpenseLimitA(); // 背景色をリセット
      
      // (v22 新規) カンマ区切り表示をリセット
      // (v23: 削除) 
      // (v24 変更) カンマ入力欄をリセット
      updateKanmaInputA('M-amount', '');
      updateKanmaInputA('M-amount-excluding-tax', '');
      
      // (v22 新規) 税率フォームをリセット (reset()だけでは 'auto' にならないため)
      document.getElementById('M-tax-rate-select').value = 'auto';
      toggleCustomTaxRateA(); // 手入力欄を非表示
    }

    /**
     * (A) (v22 変更) 領収書画像アップロード処理 (AI-OCR廃止版)
     */
    function handleImageUploadA(event) {
      var file = event.target.files[0];
      if (!file) return;

      var reader = new FileReader();
      reader.readAsDataURL(file);
      reader.onload = function() {
        var base64Image = reader.result;
        
        // (v22 変更) OCRステータス -> URL欄
        var statusEl = document.getElementById('M-receiptUrl');
        statusEl.value = 'アップロード中です...';
        
        showLoading(true, '領収書をアップロード中...');
        
        google.script.run
          .withSuccessHandler(onReceiptUploadSuccessA) // (v22) 成功ハンドラをリネーム
          .withFailureHandler(onApiError)
          .uploadReceiptImage(base64Image); // (v22) AI-OCRではなく、画像保存関数を呼ぶ
      };
      reader.onerror = function(error) {
        console.error("File reading error: ", error);
        showCustomAlert('ファイルの読み込みに失敗しました。'); // (v18 修正)
      };
    }

    /**
     * (A) (v22 変更) AI-OCR成功時のコールバックをリネーム (onOcrSuccessA -> onReceiptUploadSuccessA)
     * @param {object} result { status: "success", url: "..." }
     */
    function onReceiptUploadSuccessA(result) {
      showLoading(false);
      
      // (v22) result は { status: "success", url: "..." } または { status: "error", ... }
      if (result && result.status === 'success' && result.url) {
        
        // (v22 変更) フォームに自動入力 (URLのみ)
        document.getElementById('M-receiptUrl').value = result.url;
        
        // (v22 削除) OCRによる自動入力ロジックはすべて削除
        
      } else {
        onApiError((result && result.message) || '領収書のアップロードに失敗しました。'); // (v18 修正)
        document.getElementById('M-receiptUrl').value = 'アップロード失敗';
      }
    }

    /**
     * (A) (v20 新規) 経費項目コード（日当/宿泊費）の上限額を取得
     * @param {string} itemCode '101' (日当) または '102' (宿泊費)
     * @param {string} [areaCode] '102' (宿泊費) の場合のみ
     * @returns {number | null} 上限額 (見つからない場合は null)
     */
    function getExpenseLimitA(itemCode, areaCode) {
      try {
        var userPositionCode = EMPLOYEE_INFO.positionCode;
        if (!userPositionCode) {
          console.warn('ユーザーの役職コードが見つかりません。');
          return null;
        }
        
        // 1. ユーザーの役職コードで「出張旅費規定マスタ」を検索
        // (v20) マスタの「役職」列は数値の可能性があるため、== で比較
        var rule = TRAVEL_RULES_MASTER.find(function(r) {
          return String(r['役職']) === String(userPositionCode);
        });
        
        if (!rule) {
          console.warn('役職コード ' + userPositionCode + ' に一致する旅費規定が見つかりません。');
          return null;
        }

        // 2. 項目コードに応じて上限額を計算
        var limit = null;
        
        if (itemCode === '101') { // 日当
          limit = parseFloat(rule['日当']) || 0;
        } 
        else if (itemCode === '102') { // 宿泊費
          var baseFee = parseFloat(rule['宿泊費']) || 0;
          
          // エリア加算
          var areaFee = 0;
          var targetAreaCode = areaCode || '000000'; // デフォルトは「その他」
          
          var areaRule = LODGING_AREAS_MASTER.find(function(a) {
             return String(a['地域区分']) === String(targetAreaCode);
          });
          
          if (areaRule) {
            areaFee = parseFloat(areaRule['追加宿泊費']) || 0;
          }
          
          limit = baseFee + areaFee;
        }
        
        currentExpenseLimit = limit; // グローバル変数に上限を保存
        return limit;
        
      } catch (e) {
        console.error('getExpenseLimitA エラー:', e);
        currentExpenseLimit = null;
        return null;
      }
    }
    
    /**
     * (A) (v20 新規) 経費項目(select)の変更イベントハンドラ (v24: カンマ入力対応)
     */
    function onItemCodeChangeA() {
      var itemCode = document.getElementById('M-itemCode').value;
      var areaWrapper = document.getElementById('M-area-wrapper');
      var areaSelect = document.getElementById('M-areaCode');
      var amountInput = document.getElementById('M-amount'); // (v24) 隠された number input
      // (v23: 削除) var amountNote = document.getElementById('M-amount-limit-note');
      
      // リセット
      // (v23: 削除) amountNote.textContent = '';
      currentExpenseLimit = null;
      
      if (itemCode === '101') { // 日当
        areaWrapper.style.display = 'none';
        areaSelect.required = false;
        areaSelect.value = ''; // エリア選択をクリア
        
        var limit = getExpenseLimitA(itemCode);
        if (limit !== null) {
          // (v24 変更) カンマ入力更新用の関数を使用
          updateKanmaInputA('M-amount', limit); // 初期値としてセット
          // (v23: 削除) amountNote.textContent = '規定額: ' + formatNumber(limit) + '円';
        } else {
          // (v24 変更) カンマ入力更新用の関数を使用
          updateKanmaInputA('M-amount', ''); // 規定が見つからない
        }
        
      } else if (itemCode === '102') { // 宿泊費
        areaWrapper.style.display = 'block';
        areaSelect.required = true;
        
        // エリアが未選択の場合、デフォルト「その他」で計算
        var currentAreaCode = areaSelect.value || '000000';
        var limit = getExpenseLimitA(itemCode, currentAreaCode);
        
        if (limit !== null) {
          // (v24 変更) カンマ入力更新用の関数を使用
          updateKanmaInputA('M-amount', limit); // 初期値としてセット
          // (v23: 削除) amountNote.textContent = '上限額: ' + formatNumber(limit) + '円';
        } else {
          // (v24 変更) カンマ入力更新用の関数を使用
          updateKanmaInputA('M-amount', ''); // 規定が見つからない
        }
        
      } else { // その他の項目
        areaWrapper.style.display = 'none';
        areaSelect.required = false;
        areaSelect.value = '';
        // (v24 変更) カンマ入力更新用の関数を使用
        updateKanmaInputA('M-amount', ''); // 金額をクリア (初期値は設定しない)
      }
      
      // (v22 新規) 規定額がセットされた場合、税計算とカンマ表示をトリガー
      handleTaxCalculationA({ target: { id: 'M-amount' } });
      
      // 最後に、セットされた金額で上限チェック（背景色リセット）
      checkExpenseLimitA();
    }
    
    /**
     * (A) (v20 新規) エリア(select)の変更イベントハンドラ (宿泊費) (v24: カンマ入力対応)
     */
    function onAreaCodeChangeA() {
      var itemCode = document.getElementById('M-itemCode').value;
      
      // 宿泊費が選択されている場合のみ
      if (itemCode === '102') {
        var areaCode = document.getElementById('M-areaCode').value;
        var limit = getExpenseLimitA(itemCode, areaCode);
        
        if (limit !== null) {
          // (v24 変更) カンマ入力更新用の関数を使用
          updateKanmaInputA('M-amount', limit); // 初期値としてセット
          // (v23: 削除) document.getElementById('M-amount-limit-note').textContent = '上限額: ' + formatNumber(limit) + '円';
        } else {
          // (v24 変更) カンマ入力更新用の関数を使用
          updateKanmaInputA('M-amount', '');
          // (v23: 削除) document.getElementById('M-amount-limit-note').textContent = '規定が見つかりません。';
        }
        
        // (v22 新規) 規定額がセットされた場合、税計算とカンマ表示をトリガー
        handleTaxCalculationA({ target: { id: 'M-amount' } });
        
        checkExpenseLimitA();
      }
    }
    
    /**
     * (A) (v20 新規) 金額入力の上限チェック (v24: カンマ入力対応)
     */
    function checkExpenseLimitA() {
      var amountInput = document.getElementById('M-amount'); // (v24) 隠された number input
      
      // currentExpenseLimit は getExpenseLimitA または onItemCodeChangeA でセットされる
      if (currentExpenseLimit !== null) {
        var currentAmount = parseFloat(amountInput.value) || 0;
        
        // (v24 変更) 表示用の input (M-amount-display-input) のスタイルを変更
        var displayInput = document.getElementById('M-amount-display-input');
        
        if (currentAmount > currentExpenseLimit) {
          if (displayInput) displayInput.classList.add('amount-over-limit'); // 黄色
        } else {
          if (displayInput) displayInput.classList.remove('amount-over-limit'); // 白
        }
      } else {
        // 規定がない項目はチェックしない
        // (v24 変更) 表示用の input (M-amount-display-input) のスタイルをリセット
        var displayInput = document.getElementById('M-amount-display-input');
        if (displayInput) displayInput.classList.remove('amount-over-limit'); // 白
      }
    }


    /**
     * (A) モーダルから経費アイテムを currentExpenses に追加 (v20, v22, v24 修正)
     */
    function addExpenseItemA() {
      // バリデーション
      var form = document.getElementById('expense-form');
      if (!form.checkValidity()) {
        form.classList.add('was-validated');
        // (v20) エリア未選択で失敗する場合がある
        showCustomAlert('必須項目（利用日、経費項目、金額、エリア）を入力してください。'); // (v18 修正)
        return;
      }
      form.classList.remove('was-validated');
      
      var expenseId = document.getElementById('M-expenseId').value;
      var timeSlot = document.getElementById('M-timeSlot').value;
      
      var expense = {
        // expenseId: (v19) 
        timeSlot: timeSlot,
        useDate: document.getElementById('M-useDate').value,
        itemCode: document.getElementById('M-itemCode').value,
        amount: parseFloat(document.getElementById('M-amount').value) || 0, // 税込 (v24: 隠された input から)
        remarks: document.getElementById('M-remarks').value,
        receiptUrl: document.getElementById('M-receiptUrl').value,
        areaCode: document.getElementById('M-areaCode').value || '', // v20: 追加
        
        // (v22 新規) 税関連のデータを追加
        taxExcludedAmount: parseFloat(document.getElementById('M-amount-excluding-tax').value) || 0, // (v24: 隠された input から)
        taxRate: document.getElementById('M-tax-rate-select').value, // '10', '8', 'custom' など
        taxRateCustom: parseFloat(document.getElementById('M-tax-rate-custom').value) || null // 手入力された数値
      };
      
      if (expenseId) {
        // (v19 修正) 編集モード
        expense.expenseId = expenseId; // IDを保持
        var index = currentExpenses.findIndex(function(ex) { return ex.expenseId === expenseId; });
        if (index > -1) {
          currentExpenses[index] = expense; // 配列を上書き
        } else {
          // 念のため (IDがあるのに配列にない場合)
          currentExpenses.push(expense);
        }
      } else {
        // (v19 修正) 新規モード
        expense.expenseId = 'temp_' + Date.now(); // 新規一時ID
        currentExpenses.push(expense);
      }
      
      // バッジ更新
      updateExpenseBadgeA(timeSlot);
      
      expenseModalInstance.hide();
    }
    
    /**
     * (A) (v19 新規) 経費アイテムを削除
     */
    function deleteExpenseItemA() {
      var expenseId = document.getElementById('M-expenseId').value;
      var timeSlot = document.getElementById('M-timeSlot').value;
      
      if (!expenseId) {
        showCustomAlert('削除対象の経費が見つかりません。');
        return;
      }
      
      showCustomAlert('この経費を削除します。よろしいですか？', function() {
        // (v19) currentExpenses 配列から該当IDを削除
        currentExpenses = currentExpenses.filter(function(ex) {
          return ex.expenseId !== expenseId;
        });
        
        // バッジ更新
        updateExpenseBadgeA(timeSlot);
        
        expenseModalInstance.hide();
      });
    }

    /**
     * (A) 指定された時間枠の経費バッジを更新 (v17 修正)
     * @param {string} timeSlot "07:00" など
     */
    function updateExpenseBadgeA(timeSlot) {
      // (v17 修正) GASからマッピングされた 'timeSlot' キーを見る
      var count = currentExpenses.filter(function(ex) {
        return ex.timeSlot === timeSlot;
      }).length; 
      
      var countEl = document.getElementById('expense-count-' + timeSlot);
      var badgeEl = document.getElementById('expense-badge-' + timeSlot);
      
      if (countEl && badgeEl) {
        countEl.textContent = count;
        if (count > 0) {
          badgeEl.classList.add('has-expense');
        } else {
          badgeEl.classList.remove('has-expense');
        }
      }
    }
    
    /**
     * (A) すべての経費バッジを更新 (編集読み込み用)
     */
    function updateAllExpenseBadgesA() {
      TIME_SLOTS.forEach(function(timeSlot) {
        updateExpenseBadgeA(timeSlot);
      });
    }

    /**
     * (A) (v16 新規) 活動データを連続圧縮する
     * @param {object} activitiesObj {"07:00": {type: "移動", ...}, "07:30": {type: "移動", ...}, ...}
     * @returns {Array} [{startTime, endTime, type, content}, ...]
     */
    function compressActivities_(activitiesObj) {
      var compressed = [];
      var currentBlock = null;

      // TIME_SLOTS ("07:00" to "18:00") をループ
      for (var i = 0; i < TIME_SLOTS.length - 1; i++) {
        var startTime = TIME_SLOTS[i];
        var endTime = TIME_SLOTS[i+1];
        var act = activitiesObj[startTime]; // "07:00" の活動
        
        // 1. 活動が入力されていない場合
        if (!act || !act.type) {
          if (currentBlock) {
            // 直前までのブロックを確定
            compressed.push(currentBlock);
            currentBlock = null;
          }
          continue;
        }

        // 2. 最初のブロックを開始
        if (!currentBlock) {
          currentBlock = {
            startTime: startTime,
            endTime: endTime,
            type: act.type,
            content: act.content || ''
          };
          continue;
        }

        // 3. 活動が連続しているかチェック (type と content が両方一致)
        if (currentBlock.type === act.type && currentBlock.content === (act.content || '')) {
          // 連続 -> 終了時刻を更新
          currentBlock.endTime = endTime;
        } else {
          // 連続していない -> 既存ブロックを確定し、新ブロックを開始
          compressed.push(currentBlock);
          currentBlock = {
            startTime: startTime,
            endTime: endTime,
            type: act.type,
            content: act.content || ''
          };
        }
      }
      
      // 最後のブロックが残っていれば確定
      if (currentBlock) {
        compressed.push(currentBlock);
      }
      
      return compressed;
    }

    /**
     * (A) 日報の保存または申請 (v18 修正: カスタムアラート) (v22: 経費データ)
     * @param {'一時保存' | '申請中'} status
     */
    function saveOrSubmitReportA(status) {
      
      // (v17 修正) 保存直前に走行距離の表示内容を更新する
      calculateMileageA();
      
      // バリデーション
      var reportDate = document.getElementById('A-date').value;
      if (!reportDate) {
        showCustomAlert('日付は必須です。'); // (v18 修正)
        return;
      }
      
      // 活動データが1件以上あるかチェック (typeが入力されているか)
      var filledActivities = Object.values(currentActivities).filter(function(act) {
        return act.type;
      });
      if (filledActivities.length === 0) {
        showCustomAlert('活動内容が1件も入力されていません。'); // (v18 修正)
        return;
      }
      
      // (v18 修正) 確認ダイアログをカスタムモーダルに変更
      var confirmMessage = '「' + status + '」で送信します。よろしいですか？';
      if (status === '申請中') {
         confirmMessage += '\n※申請後は編集できなくなります。';
      }
      
      showCustomAlert(confirmMessage, function() {
        // --- OKが押された場合の処理 ---
        showLoading(true, status + '処理を実行中...');
        
        // 走行距離
        var mileage = parseFloat(document.getElementById('A-mileageDisplay').textContent) || 0;
        
        // 1. ヘッダーデータ
        var headerData = {
          reportId: document.getElementById('A-reportId').value,
          date: reportDate, // "yyyy-MM-dd"
          remarks: document.getElementById('A-remarks').value,
          startMeter: document.getElementById('A-startMeter').value,
          endMeter: document.getElementById('A-endMeter').value,
          mileage: mileage,
        };

        // 2. (v16 修正) 行動明細データを圧縮
        var activityData = compressActivities_(currentActivities);
        
        // 3. 経費明細データ (currentExpenses はそのまま)
        // (v20: areaCode, v22: tax* も含まれる)
        
        var reportData = {
          header: headerData,
          activities: activityData, // 圧縮済み配列を渡す
          expenses: currentExpenses // (v20, v22)
        };
        
        // console.log("Submitting data:", reportData);

        google.script.run
          .withSuccessHandler(function(result) {
            showLoading(false);
            // v11: 詳細エラー表示
            if (result && result.status === 'success') {
              showCustomAlert(result.message, function() { // (v18 修正)
                // 成功したらフォームをリセットし、一覧に遷移
                resetFormA();
                showView('view-E-my-reports');
              });
            } else {
              onApiError((result && result.message) || '保存処理に失敗しました。');
            }
          })
          .withFailureHandler(onApiError)
          .saveOrSubmitDailyReport(reportData, status);
        // --- OKが押された場合の処理ここまで ---
      });
    }


    // --- (B) 承認待ち一覧機能 -------------------------------------------

    /**
     * (B) 承認待ち一覧をロード
     */
    function loadPendingReportsB() {
      showLoading(true, '承認待ち一覧を取得中...');
      google.script.run
        .withSuccessHandler(onLoadPendingReportsSuccessB)
        .withFailureHandler(onApiError)
        .getPendingReports();
    }

    /**
     * (B) 承認待ち一覧 取得成功 (v17 修正: 日付フォーマット)
     * @param {Array<object>} reports
     */
    function onLoadPendingReportsSuccessB(reports) {
      showLoading(false);
      var listBody = document.getElementById('B-approval-list-body');
      var badge = document.getElementById('approval-count-badge');
      listBody.innerHTML = '';
      
      if (!reports || reports.length === 0) { // v7: null check
        listBody.innerHTML = '<div class="list-group-item">承認待ちの日報はありません。</div>';
        badge.textContent = '';
        return;
      }

      badge.textContent = reports.length;
      
      // 日付でソート (昇順)
      reports.sort(function(a, b) {
        return (a['日付'] || '').localeCompare(b['日付'] || '');
      });

      reports.forEach(function(report) {
        // (v17 修正) GASが yyyy/MM/dd を返す
        var dateStr = report['日付'] || '日付不明';
        var formattedDate = '';
        try {
           // (v17 修正) 曜日だけ取得
           formattedDate = new Date(dateStr.replace(/\//g, '-')).toLocaleDateString('ja-JP', { weekday: 'short' });
        } catch(e) {
           formattedDate = '日付不正';
        }
        
        var item = document.createElement('a');
        item.href = '#';
        item.className = 'list-group-item list-group-item-action d-flex justify-content-between align-items-center report-list-item';
        item.onclick = function(e) {
          e.preventDefault();
          loadReportDetailsC(report['日報ID'], 'view-B-approval-list');
        };
        
        item.innerHTML = 
          '<div>' +
            '<h5 class="mb-1">' + dateStr + ' (' + formattedDate + ')</h5>' + // (v17 修正)
            '<p class="mb-1">申請者: ' + (report['担当者'] || '不明') + '</p>' +
            '<small>合計経費: ' + formatNumber(report['合計経費'] || 0) + ' 円</small>' +
          '</div>' +
          '<i class="bi bi-chevron-right h4"></i>';
        listBody.appendChild(item);
      });
    }

    // --- (C) 日報詳細機能 -----------------------------------------------

    /**
     * (C) 日報詳細をロード
     * @param {string} reportId 日報ID
     * @param {string} returnViewId 戻り先のビューID
     */
    function loadReportDetailsC(reportId, returnViewId) {
      showLoading(true, '日報詳細を取得中...');
      viewC_ReturnView = returnViewId; // 戻り先をセット
      
      google.script.run
        .withSuccessHandler(onLoadReportDetailsSuccessC)
        .withFailureHandler(onApiError)
        .getReportDetails(reportId);
    }
    
    /**
     * (C) 日報詳細 取得成功 (v20, v22 修正: 経費テーブル)
     * @param {object} data { header, activities, expenses }
     */
    function onLoadReportDetailsSuccessC(data) {
      // v7: ローディングを先に解除
      showLoading(false);
      
      // v11 修正: データが不正か、対象が見つからない場合
      if (!data || !data.header || !data.header['日報ID']) {
        console.error('onLoadReportDetailsSuccessC: Invalid data received.', data);
        onApiError('詳細データの取得に失敗しました。データが不正か、対象が見つかりません。');
        return;
      }

      var header = data.header;
      var activities = data.activities;
      var expenses = data.expenses;
      
      // 1. ヘッダー
      // (v17 修正) GASが yyyy/MM/dd を返す
      document.getElementById('C-header-date').textContent = header['日付'] ? formatDateWithDay(header['日付']) : '日付なし';
      document.getElementById('C-header-applicant').textContent = header['担当者'] || '不明';
      document.getElementById('C-header-apply-date').textContent = header['申請日'] || 'N/A'; // (v17 修正) yyyy/MM/dd HH:mm:ss
      document.getElementById('C-header-mileage').textContent = header['走行距離'] || 0;
      document.getElementById('C-header-total-expense').textContent = formatNumber(header['合計経費'] || 0);
      document.getElementById('C-header-remarks').textContent = header['備考'] || '(備考なし)';
      
      // v5 修正: 時間合計の表示
      document.getElementById('C-header-movement-time').textContent = formatHours(header['移動時間合計 (時間)']);
      document.getElementById('C-header-meeting-time').textContent = formatHours(header['商談時間合計 (時間)']);

      // ステータスバッジ
      var statusBadge = document.getElementById('C-header-status-badge');
      statusBadge.textContent = header['承認ステータス'];
      statusBadge.className = 'badge fs-6'; // reset
      switch (header['承認ステータス']) {
        case '申請中': statusBadge.classList.add('bg-primary'); break;
        case '承認済': statusBadge.classList.add('bg-success'); break;
        case '差戻し': statusBadge.classList.add('bg-danger'); break;
        case '一時保存': statusBadge.classList.add('bg-warning', 'text-dark'); break;
        case '精算申請済': statusBadge.classList.add('bg-info', 'text-dark'); break;
        default: statusBadge.classList.add('bg-secondary');
      }
      
      // (v18 新規) 差戻し理由の表示
      var reasonWrapper = document.getElementById('C-rejection-reason-wrapper');
      var reasonPre = document.getElementById('C-rejection-reason');
      if (header['差戻し理由']) {
        reasonPre.textContent = header['差戻し理由'];
        reasonWrapper.style.display = 'block';
      } else {
        reasonPre.textContent = '';
        reasonWrapper.style.display = 'none';
      }
      
      // 2. 行動明細
      var actBody = document.getElementById('C-activities-body');
      actBody.innerHTML = '';
      if (activities && activities.length > 0) { // v7: null check
        // 時刻でソート
        activities.sort(function(a, b) {
          return (a['開始時刻'] || '').localeCompare(b['開始時刻'] || '');
        });
        activities.forEach(function(act) {
          actBody.innerHTML += 
            '<tr>' +
              '<td>' + (act['開始時刻'] || '') + ' - ' + (act['終了時刻'] || '') + '</td>' +
              '<td>' + (act['活動区分'] || '') + '</td>' +
              '<td>' + (act['活動内容'] || '') + '</td>' +
            '</tr>';
        });
      } else {
        actBody.innerHTML = '<tr><td colspan="3">行動明細はありません。</td></tr>';
      }
      
      // 3. 経費明細 (v22: 税関連の表示)
      var expBody = document.getElementById('C-expenses-body');
      expBody.innerHTML = '';
      if (expenses && expenses.length > 0) { // v7: null check
      
        // (v20) エリアマスタをMap化
        var areaMap = {};
        LODGING_AREAS_MASTER.forEach(function(a) {
          areaMap[a['地域区分']] = a['地域区分名'];
        });
      
        expenses.forEach(function(ex) {
          // (v17 修正) GASが yyyy/MM/dd を返す
          var useDate = ex.useDate || 'N/A'; // (v17) マッピングされたキー
          var url = ex.receiptUrl; // (v17) マッピングされたキー
          var urlLink = url ? '<a href="' + url + '" target="_blank" rel="noopener noreferrer"><i class="bi bi-box-arrow-up-right"></i></a>' : '';
          
          // (v20) エリア名を取得
          var areaName = (ex.areaCode && areaMap[ex.areaCode]) ? areaMap[ex.areaCode] : '';
          
          // (v22) 税率表示
          var taxRateDisplay = 'N/A';
          if (ex.taxRate === 'custom') {
            taxRateDisplay = (ex.taxRateCustom || '0') + '% (手入力)';
          } else if (ex.taxRate === 'auto') {
            taxRateDisplay = '---';
          } else if (ex.taxRate) {
            taxRateDisplay = ex.taxRate + '%';
          }
          
          // (v19 修正) 経費テーブルに「時間帯」列を追加
          // (v22 修正) 経費テーブルに「税抜」「税率」列を追加
          expBody.innerHTML += 
            '<tr>' +
              '<td>' + (ex.timeSlot || 'N/A') + '</td>' + // (v19 追加)
              '<td>' + useDate + '</td>' +
              '<td>' + (ex.itemName || '不明な項目') + '</td>' +
              '<td>' + formatNumber(ex.amount || 0) + '</td>' + // (v17) 税込金額
              '<td>' + areaName + '</td>' + // (v20) エリア名
              // --- (v22) 税関連 ---
              '<td>' + formatNumber(ex.taxExcludedAmount || 0) + '</td>' + // 税抜金額
              '<td>' + taxRateDisplay + '</td>' + // 税率
              // ---
              '<td>' + (ex.remarks || '') + '</td>' + // (v17) マッピングされたキー
              '<td>' + urlLink + '</td>' +
            '</tr>';
        });
      } else {
        expBody.innerHTML = '<tr><td colspan="9">経費明細はありません。</td></tr>'; // (v22 修正) colspan="7" -> 9
      }
      
      // 4. 承認ボタンの制御
      var approvalButtons = document.getElementById('C-approval-buttons');
      // 管理者 かつ ステータスが "申請中" かつ 戻り先が "承認待ち" の場合のみ表示
      if (IS_MANAGER && header['承認ステータス'] === '申請中' && viewC_ReturnView === 'view-B-approval-list') {
        document.getElementById('C-reportId').value = header['日報ID'];
        approvalButtons.style.display = 'block';
      } else {
        approvalButtons.style.display = 'none';
      }
      
      // (C)ビューに遷移
      // showLoading(false); // v7: 先頭に移動
      showView('view-C-report-detail');
    }

    /**
     * (C) 承認処理 (v18 修正: カスタムアラート)
     */
    function handleApproveC() {
      var reportId = document.getElementById('C-reportId').value;
      if (!reportId) return;
      
      showCustomAlert('この日報を「承認」します。よろしいですか？', function() { // (v18 修正)
        // OK後の処理
        showLoading(true, '承認処理中...');
        google.script.run
          .withSuccessHandler(function(result) {
            showLoading(false);
            showCustomAlert(result.message, function() { // (v18 修正)
              // 承認待ち一覧 (B) に戻る
              showView('view-B-approval-list');
            });
          })
          .withFailureHandler(onApiError)
          .approveReport(reportId);
      });
    }
    
    /**
     * (C) 差戻し処理 (v18 修正: カスタムプロンプト)
     */
    function handleRejectC() {
      var reportId = document.getElementById('C-reportId').value;
      if (!reportId) return;
      
      // (v18 修正) カスタムプロンプトを使用
      showCustomPrompt('差戻し理由を入力してください（必須）:', function(reason) {
        if (!reason) {
          // showCustomAlert("差戻し理由が入力されていないため、処理を中断しました。");
          // (v18) キャンセルの場合はアラート不要
          return;
        }
        
        // 理由が入力された場合
        showLoading(true, '差戻し処理中...');
        google.script.run
          .withSuccessHandler(function(result) {
            showLoading(false);
            showCustomAlert(result.message, function() { // (v18 修正)
              // 承認待ち一覧 (B) に戻る
              showView('view-B-approval-list');
            });
          })
          .withFailureHandler(onApiError)
          .rejectReport(reportId, reason); // (v15 修正) 理由を渡す
      });
    }

    // --- (D) 経費精算まとめ機能 ----------------------------------------

    /**
     * (D) 承認済みの経費一覧をロード
     */
    function loadApprovedExpensesD() {
      showLoading(true, '精算可能な経費を取得中...');
      google.script.run
        .withSuccessHandler(onLoadApprovedExpensesSuccessD)
        .withFailureHandler(onApiError)
        .getApprovedExpenses();
    }
    
    /**
     * (D) 承認済み経費 取得成功 (v17 修正: 日付フォーマット) (v22: 経費項目)
     * @param {object} data { reports: [], expenses: [] }
     */
    function onLoadApprovedExpensesSuccessD(data) {
      showLoading(false);
      var tbody = document.getElementById('D-expense-list-body');
      tbody.innerHTML = '';
      
      var reports = (data && data.reports) ? data.reports : []; // v7: null check
      var expenses = (data && data.expenses) ? data.expenses : []; // v7: null check
      
      if (reports.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" class="text-center">精算対象の「承認済」日報はありません。</td></tr>';
        updateTotalSelectedAmountD();
        return;
      }
      
      // 日付の昇順でソート
      reports.sort(function(a, b) {
        return (a['日付'] || '').localeCompare(b['日付'] || '');
      });

      // v5 修正: 経費データをレポートIDで集計
      var expensesMap = {};
      expenses.forEach(function(ex) {
        var rId = ex['日報ID'];
        if (!expensesMap[rId]) {
          expensesMap[rId] = [];
        }
        // (v22) ex.itemName (マージ済み) を使用, ex['金額'] (税込) を使用
        expensesMap[rId].push(ex.itemName + ': ' + formatNumber(ex['金額']) + '円');
      });

      reports.forEach(function(report) {
        var tr = document.createElement('tr');
        var reportId = report['日報ID'];
        var totalExpense = parseFloat(report['合計経費']) || 0;
        var date = report['日付']; // (v17 修正) GASが yyyy/MM/dd を返す
        
        // 経費詳細の文字列
        var expenseDetails = (expensesMap[reportId] || []).join('<br>');
        
        tr.innerHTML = 
          '<td>' +
            '<input class="form-check-input D-checkbox" type="checkbox" ' +
                    'value="' + reportId + '" ' +
                    'data-amount="' + totalExpense + '" ' +
                    'onchange="updateTotalSelectedAmountD()">' +
          '</td>' +
          '<td>' + date + '</td>' +
          '<td>' + formatNumber(totalExpense) + '</td>' +
          '<td><small>' + (expenseDetails || '(経費なし)') + '</small></td>' +
          '<td><small>' + String(reportId).substring(0, 8) + '...</small></td>'; // v7: String()
        tbody.appendChild(tr);
      });
      
      updateTotalSelectedAmountD();
    }

    /**
     * (D) チェックボックス全選択/全解除
     */
    function toggleAllCheckboxesD(checked) {
      document.querySelectorAll('.D-checkbox').forEach(function(cb) {
        cb.checked = checked;
      });
      updateTotalSelectedAmountD();
    }
    
    /**
     * (D) 選択合計金額を更新
     */
    function updateTotalSelectedAmountD() {
      var total = 0;
      document.querySelectorAll('.D-checkbox:checked').forEach(function(cb) {
        total += parseFloat(cb.dataset.amount) || 0;
      });
      document.getElementById('D-total-selected-amount').textContent = formatNumber(total) + ' 円';
    }
    
    /**
     * (D) 最終精算申請を送信 (v18 修正: カスタムアラート)
     */
    function submitFinalExpensesD() {
      var selectedIds = [];
      document.querySelectorAll('.D-checkbox:checked').forEach(function(cb) {
        selectedIds.push(cb.value);
      });
      
      if (selectedIds.length === 0) {
        showCustomAlert('精算申請する日報を選択してください。'); // (v18 修正)
        return;
      }
      
      var confirmMessage = '選択した ' + selectedIds.length + ' 件の日報を経理に精算申請します。\nよろしいですか？';
      showCustomAlert(confirmMessage, function() { // (v18 修正)
        // OK後の処理
        showLoading(true, '精算申請を送信中...');
        google.script.run
          .withSuccessHandler(function(result) {
            showLoading(false);
            showCustomAlert(result.message, function() { // (v18 修正)
              // 成功したら一覧をリロード
              loadApprovedExpensesD();
            });
          })
          .withFailureHandler(onApiError)
          .submitFinalExpenses(selectedIds);
      });
    }

    // --- (E) 日報一覧機能 ----------------------------------------------

    /**
     * (E) 自分の日報一覧をロード (タイムアウト対策版)
     */
    function loadMyReportsE() {
      showLoading(true, '日報一覧を取得中...');
      google.script.run
        .withSuccessHandler(onLoadMyReportsSuccessE)
        .withFailureHandler(onApiError)
        .getMyReports();
    }

    /**
     * (E) 日報一覧 取得成功 (v17 修正: 日付フォーマット)
     * @param {Array<object>} reports
     */
    function onLoadMyReportsSuccessE(reports) {
      showLoading(false);
      var tbody = document.getElementById('E-my-reports-list-body');
      tbody.innerHTML = '';

      if (!reports || reports.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" class="text-center">日報データはありません。</td></tr>';
        return;
      }
      
      reports.forEach(function(report) {
        var tr = document.createElement('tr');
        var rId = report['日報ID']; // v5: report.reportId -> report['日報ID']
        var status = report['承認ステータス']; // v5
        
        var statusBadge = '';
        switch (status) { // v5: report.status -> status
          case '申請中': statusBadge = '<span class="badge bg-primary">申請中</span>'; break;
          case '承認済': statusBadge = '<span class="badge bg-success">承認済</span>'; break;
          case '差戻し': statusBadge = '<span class="badge bg-danger">差戻し</span>'; break;
          case '一時保存': statusBadge = '<span class="badge bg-warning text-dark">一時保存</span>'; break;
          case '精算申請済': statusBadge = '<span class="badge bg-info text-dark">精算申請済</span>'; break;
          default: statusBadge = '<span class="badge bg-secondary">' + status + '</span>';
        }

        // 編集/表示ボタンの出し分け
        var buttons = '';
        if (status === '一時保存' || status === '差戻し') { // v5: report.status -> status
          // 編集可能
          buttons = '<button class="btn btn-sm btn-primary" onclick="handleEditReportE(\'' + rId + '\')"><i class="bi bi-pencil"></i> 編集</button>';
        } else {
          // 表示のみ
          buttons = '<button class="btn btn-sm btn-outline-secondary" onclick="loadReportDetailsC(\'' + rId + '\', \'view-E-my-reports\')"><i class="bi bi-eye"></i> 表示</button>';
        }
        
        tr.innerHTML = 
          '<td>' + (report['日付'] || '') + '</td>' + // (v17 修正) GASが yyyy/MM/dd を返す
          '<td>' + statusBadge + '</td>' +
          '<td>' + formatNumber(report['合計経費']) + '</td>' + // v5
          '<td><small>' + (report['備考'] || '') + '</small></td>' + // v5
          '<td>' + buttons + '</td>';
        
        // 編集ボタン以外がクリックされたら詳細表示 (イベント伝播停止)
        tr.addEventListener('click', function(e) {
          if (!e.target.closest('button')) {
            loadReportDetailsC(rId, 'view-E-my-reports');
          }
        });
        
        tbody.appendChild(tr);
      });
    }
    
    /**
     * (E) 編集ボタンクリック時の処理 (v18 修正: カスタムアラート)
     */
    function handleEditReportE(reportId) {
      showCustomAlert('この日報データを編集します。入力中の内容は破棄されますが、よろしいですか？', function() { // (v18 修正)
        // OK後の処理
        showLoading(true, '編集データを読み込み中...');
        google.script.run
          .withSuccessHandler(onLoadReportForEditSuccessA)
          .withFailureHandler(onApiError)
          .getReportDataForEdit(reportId);
      });
    }
    
    /**
     * (A) 編集データの読み込み成功 (E -> A) (v20 修正: 経費読み込み) (v22: 税項目)
     * @param {object} result { status, data, message }
     */
    function onLoadReportForEditSuccessA(result) {
      showLoading(false);

      if (!result) {
        console.error('onLoadReportForEditSuccessA: Failed to load data. Result is null.');
        onApiError('編集データの読み込みに失敗しました。(result: null)');
        return;
      }
      
      if (result.status === 'success' && result.data && result.data.header && result.data.header['日報ID']) {
        var data = result.data;
        var h = data.header;
        
        // 1. フォーム(A)をリセット (v18: この中で経費バッジがクリアされる)
        resetFormA();
        
        // 2. (v16 修正) 展開済みの activities オブジェクトをセット
        currentActivities = data.activities || {};
        currentExpenses = data.expenses || []; // (v20: areaCode, v22: tax* も含まれる)

        // 3. (v14 修正) タイムシートを描画 (v18: バッジ更新はしない)
        renderTimesheetA();
        
        // (v18 修正) currentExpenses をセットした *後* でバッジを更新
        updateAllExpenseBadgesA();
        
        // 4. (v14 修正) 最後にヘッダー情報をフォームにセット
        document.getElementById('A-reportId').value = h['日報ID'] || '';
        // (v17 修正) GASが yyyy/MM/dd を返すため、input[type=date]用に yyyy-MM-dd に変換
        document.getElementById('A-date').value = h['日付'] ? h['日付'].replace(/\//g, '-') : getTodayString();
        document.getElementById('A-remarks').value = h['備考'] || '';
        document.getElementById('A-startMeter').value = h['始時メーター'] || '';
        document.getElementById('A-endMeter').value = h['終時メーター'] || '';
        
        // (v15 修正) 差戻し理由を表示
        var reasonDiv = document.getElementById('A-rejection-reason');
        if (h['差戻し理由']) { // v15: 「差戻し理由」列がスプレッドシートにあれば
          reasonDiv.textContent = '差戻し理由: ' + h['差戻し理由'];
          reasonDiv.style.display = 'block';
        } else {
          reasonDiv.style.display = 'none';
        }
        
        // 走行距離を再計算
        calculateMileageA();
        
        // (v15 修正) 時間合計を再計算
        calculateTotalsA();

        // 6. (A)画面に遷移
        showView('view-A-daily-report');

      } else {
        // 失敗
        var errorMsg = (result && result.message) ? result.message : '編集データの読み込みに失敗しました。(status: ' + (result.status || 'unknown') + ')';
        console.error('onLoadReportForEditSuccessA: Failed to load data.', result);
        onApiError(errorMsg); // (v18 修正)
      }
    }
    
    // --- (v22 新規) 税計算 & カンマ表示 --------------------------------
    // (v24 修正: カンマ入力対応)
    
    /**
     * (A) (新規) 消費税率の「その他」手入力欄の表示/非表示を切り替える
     */
    function toggleCustomTaxRateA() {
      var select = document.getElementById('M-tax-rate-select');
      var customInput = document.getElementById('M-tax-rate-custom');
      if (select.value === 'custom') {
        customInput.style.display = 'block';
      } else {
        customInput.style.display = 'none';
        customInput.value = ''; // 隠すときに値をクリア
      }
    }

    /**
     * (A) (新規) 現在選択されている税率 (数値) を取得する
     * @returns {number | null} 税率 (10, 8, 0 など)。未選択時は null。
     */
    function getSelectedTaxRateA() {
      var select = document.getElementById('M-tax-rate-select');
      var customInput = document.getElementById('M-tax-rate-custom');
      
      if (select.value === 'custom') {
        return parseFloat(customInput.value) || 0; // 手入力優先
      }
      if (select.value === 'auto') {
        return null; // 未選択
      }
      return parseFloat(select.value) || 0;
    }

    /**
     * (A) (新規) 消費税の自動計算を実行する
     * (v24 変更: カンマ入力(hidden input)を読み書きするよう修正)
     * @param {Event} e イベントオブジェクト (どの要素が変更されたかを知るため)
     */
    function handleTaxCalculationA(e) {
      // 「その他」の表示切り替え
      toggleCustomTaxRateA();
      
      var lastChangedId = e.target.id;
      
      // (v24 変更) 隠された number input を参照
      var taxIncludedInput = document.getElementById('M-amount');
      var taxExcludedInput = document.getElementById('M-amount-excluding-tax');
      
      var taxIncluded = parseFloat(taxIncludedInput.value) || 0;
      var taxExcluded = parseFloat(taxExcludedInput.value) || 0;
      var taxRate = getSelectedTaxRateA(); // 10, 8, 0, null

      // 1. 税率が変更された場合
      if (lastChangedId === 'M-tax-rate-select' || lastChangedId === 'M-tax-rate-custom') {
        if (taxRate === null) {
           // 税率が 'auto' に戻されたら、税抜をクリアする
           // (v24 変更) カンマ入力更新用の関数を使用
           updateKanmaInputA('M-amount-excluding-tax', '');
        } else {
          // 税率が変更されたら、「税込」を基準に「税抜」を再計算する
          if (taxIncluded > 0) {
            // (v24 変更) カンマ入力更新用の関数を使用
            var newTaxExcluded = (taxRate > 0) ? Math.ceil(taxIncluded / (1 + taxRate / 100)) : taxIncluded;
            updateKanmaInputA('M-amount-excluding-tax', newTaxExcluded);
          }
          // 税込が0なら、「税抜」を基準に「税込」を再計算
          else if (taxExcluded > 0) {
            // (v24 変更) カンマ入力更新用の関数を使用
            var newTaxIncluded = Math.round(taxExcluded * (1 + taxRate / 100));
            updateKanmaInputA('M-amount', newTaxIncluded);
          }
        }
      }
      // 2. 税抜金額が変更された場合 (v24: 隠された input がトリガー)
      else if (lastChangedId === 'M-amount-excluding-tax') {
        if (taxRate !== null) {
          // 税抜と税率 -> 税込 を計算
          // (v24 変更) カンマ入力更新用の関数を使用
          var newTaxIncluded = Math.round(taxExcluded * (1 + taxRate / 100));
          updateKanmaInputA('M-amount', newTaxIncluded);
        }
      }
      // 3. 税込金額が変更された場合 (v24: 隠された input がトリガー)
      else if (lastChangedId === 'M-amount') {
        if (taxRate !== null) {
          // 税込と税率 -> 税抜 を計算
          // (v24 変更) カンマ入力更新用の関数を使用
          var newTaxExcluded = (taxRate > 0) ? Math.ceil(taxIncluded / (1 + taxRate / 100)) : taxIncluded;
          updateKanmaInputA('M-amount-excluding-tax', newTaxExcluded);
        } else {
          // 税率未選択で税込が入力されたら、税抜はクリア
          // (v24 変更) カンマ入力更新用の関数を使用
          updateKanmaInputA('M-amount-excluding-tax', '');
        }
      }
      
      // カンマ区切り表示を更新 (v23: 削除 -> v24: カンマ入力欄の更新は input イベント内で実行される)
      // updateAmountDisplayA('M-amount');
      
      // (v22) 税込金額が変更されたら、上限チェックも実行
      if (lastChangedId === 'M-amount') {
        checkExpenseLimitA();
      }
    }
    
    /**
     * (A) (v23: 削除) 金額入力欄のカンマ区切り表示を更新する
     */
    /*
    function updateAmountDisplayA(inputId) { ... }
    */

    // --- (v24 新規) カンマ入力フォーマット --------------------------------
    
    /**
     * (A) (v24 新規) カンマ入力欄のイベントリスナーを初期化
     */
    function initializeKanmaInputsA() {
      document.getElementById('M-amount-display-input').addEventListener('input', formatKanmaInputA);
      document.getElementById('M-amount-excluding-tax-display-input').addEventListener('input', formatKanmaInputA);
    }
    
    /**
     * (A) (v24 新規) カンマ入力欄のフォーマット処理
     */
    function formatKanmaInputA(e) {
      var displayInput = e.target;
      // 'M-amount-display-input' -> 'M-amount'
      var hiddenInputId = displayInput.id.replace('-display-input', '');
      var hiddenInput = document.getElementById(hiddenInputId);
      
      // 1. カンマや空白を除去して数値のみを取得
      var numericValueStr = displayInput.value.replace(/[^0-9]/g, '');
      var numericValue = parseInt(numericValueStr, 10) || 0;
      
      // 2. 隠された number input に数値をセット
      hiddenInput.value = numericValue;
      
      // 3. 表示 input にカンマ区切りをセット
      displayInput.value = numericValue > 0 ? numericValue.toLocaleString() : (numericValueStr === '0' ? '0' : '');
      
      // 4. 隠された input の 'input' イベントを発火させ、税計算や上限チェックをトリガー
      // (※ 'change' ではなく 'input' イベント)
      hiddenInput.dispatchEvent(new Event('input', { bubbles: true }));
    }
    
    /**
     * (A) (v24 新規) 隠された input とカンマ表示 input の両方をプログラムから更新する
     * (税計算、規定額セット、編集データ読み込み時に使用)
     * @param {string} hiddenInputId 'M-amount' または 'M-amount-excluding-tax'
     * @param {number | string} numericValue セットする数値
     */
    function updateKanmaInputA(hiddenInputId, numericValue) {
      var hiddenInput = document.getElementById(hiddenInputId);
      var displayInput = document.getElementById(hiddenInputId + '-display-input');
      
      if (!hiddenInput || !displayInput) return;
      
      var num = parseFloat(numericValue) || 0;
      
      // 1. 隠された input に数値をセット
      hiddenInput.value = num;
      
      // 2. 表示 input にカンマ区切りをセット
      displayInput.value = num > 0 ? num.toLocaleString() : '';
      
      // 3. (v24) 隠された input の 'input' イベントを発火 (税計算/上限チェックのため)
      // ただし、この関数自身が税計算 (handleTaxCalculationA) から呼ばれると無限ループになるため、
      // handleTaxCalculationA 側ではこの関数を呼ばないようにするか、フラグ制御が必要。
      // → handleTaxCalculationA が 'M-amount' を *読み取る* 前に 'M-amount-excluding-tax' を *書き込む* ことがあるため、
      //   ここでイベントを発火させると計算が狂う可能性がある。
      // → 対策: handleTaxCalculationA は最後に *一回だけ* 関連する input (M-amount) の
      //   イベントを発火させるか、または計算ロジック内で完結させる。
      
      // (v24) handleTaxCalculationA 内での updateKanmaInputA 呼び出しは、
      // イベント発火を伴わない「値の更新」に留める。
      // formatKanmaInputA (ユーザー入力時) のみがイベントを発火させる。
    }


  </script>
</body>
</html>
